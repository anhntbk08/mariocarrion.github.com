<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content="Mario Carrion"><meta name=description content="How to build a bunch of Go CLI containerized programs using Makefiles"><meta property=og:title content="Building Go programs using Makefiles"><meta property=og:description content="How to build a bunch of Go CLI containerized programs using Makefiles"><meta property=og:type content=article><meta property=og:url content=https://www.mariocarrion.com/2016/12/15/go-makefiles.html><meta property=article:published_time content=2016-12-15T00:00:00&#43;00:00><meta property=article:modified_time content=2016-12-15T00:00:00&#43;00:00><title>Building Go programs using Makefiles</title><link rel=canonical href=https://www.mariocarrion.com/2016/12/15/go-makefiles.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Building Go programs using Makefiles</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Thu Dec 15 2016 00:00:00 UTC">Dec 15, 2016</div></div></div><div class=markdown><p>The idiomatic way of installing binaries in Go is using <code>go install &lt;path-to-binary&gt;</code>, for example something like:<pre><code>go install github.com/MarioCarrion/go-makefiles-skeleton/cmd/hello
</code></pre><p>will build and then install the <code>hello</code> program into your <code>$GOPATH/bin</code> (of course assuming you previously <code>go get</code> it), and that is great if that&rsquo;s what you&rsquo;re looking for. However, if you&rsquo;re like me and you use <a href=/2016/10/31/small-go-docker-image.html>small docker images</a> for running your programs on production, then you need to have a Makefile for building all of them consistently; of course this does not mean you can&rsquo;t have the best of both worlds.<p>Let&rsquo;s assume you have a collection of binaries, following the common pattern of defining a package, this package is then used by all the programs in <code>cmd/</code>, so you would have something like this:<pre><code>$ ls -d *.go */*/*
cmd/hello/main.go     cmd/something/main.go something.go
</code></pre><p>I created a <a href=https://github.com/MarioCarrion/go-makefiles-skeleton>small repo</a> containing this example, so you can follow along; using that said repo you could execute:<p><code>go install github.com/MarioCarrion/go-makefiles-skeleton/cmd/...</code><p>That will build and install both programs:<pre><code>$ which hello
/home/mario/goworkspace/bin/hello
$ which something
/home/mario/goworkspace/bin/something
</code></pre><p>What is needed next is to create a Makefile for building all our binaries in a Docker image, then copy those to the static and final image which in the end will be used for the final container. You can follow the <a href=https://github.com/MarioCarrion/go-makefiles-skeleton/blob/master/Makefile>Makefile</a> from the repo, it literally contains the following:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#66d9ef>NAMESPACE</span><span style=color:#f92672>=</span><span style=color:#f8f8f2>mariocarrion</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>go</span><span style=color:#f92672>-</span><span style=color:#f8f8f2>makefiles</span><span style=color:#f92672>-</span><span style=color:#f8f8f2>skeleton</span>

<span style=color:#66d9ef>PROGRAMS</span><span style=color:#f92672>=</span><span style=color:#f8f8f2>hello</span> <span style=color:#f8f8f2>something</span>

<span style=color:#f92672>.</span><span style=color:#f8f8f2>PHONY:</span> <span style=color:#f8f8f2>clean</span>

<span style=color:#e6db74>default</span><span style=color:#f8f8f2>:</span> <span style=color:#f8f8f2>build</span>

<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f8f8f2>(</span><span style=color:#66d9ef>PROGRAMS</span><span style=color:#f8f8f2>):</span>
	<span style=color:#f8f8f2>docker</span> <span style=color:#f8f8f2>run</span> <span style=color:#f92672>--</span><span style=color:#f8f8f2>tty</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f8f8f2>{</span><span style=color:#66d9ef>NAMESPACE</span><span style=color:#f8f8f2>}</span><span style=color:#e6db74>:build</span> <span style=color:#e6db74>/bin/</span><span style=color:#66d9ef>true</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f8f8f2>\</span>
		<span style=color:#f8f8f2>docker</span> <span style=color:#f8f8f2>cp</span> <span style=color:#e6db74>`docker ps -q -n=1`:/</span><span style=color:#f8f8f2>$@</span> <span style=color:#f92672>.</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f8f8f2>\</span>
		<span style=color:#f8f8f2>docker</span> <span style=color:#f8f8f2>rm</span> <span style=color:#e6db74>`docker ps -q -n=1`</span>

<span style=color:#e6db74>builddocker</span><span style=color:#f8f8f2>:</span>
	<span style=color:#f8f8f2>docker</span> <span style=color:#f8f8f2>build</span> <span style=color:#f92672>--</span><span style=color:#f8f8f2>tag</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f8f8f2>{</span><span style=color:#66d9ef>NAMESPACE</span><span style=color:#f8f8f2>}</span><span style=color:#e6db74>:build</span> <span style=color:#f92672>--</span><span style=color:#f8f8f2>file</span> <span style=color:#f92672>.</span><span style=color:#f8f8f2>/</span><span style=color:#66d9ef>Dockerfile</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>build</span> <span style=color:#f92672>.</span>

<span style=color:#e6db74>build</span><span style=color:#f8f8f2>:</span> <span style=color:#f8f8f2>builddocker</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f8f8f2>(</span><span style=color:#66d9ef>PROGRAMS</span><span style=color:#f8f8f2>)</span>
	<span style=color:#f8f8f2>docker</span> <span style=color:#f8f8f2>run</span> <span style=color:#f92672>--</span><span style=color:#f8f8f2>tty</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f8f8f2>{</span><span style=color:#66d9ef>NAMESPACE</span><span style=color:#f8f8f2>}</span><span style=color:#e6db74>:build</span> <span style=color:#e6db74>/bin/</span><span style=color:#66d9ef>true</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f8f8f2>\</span>
		<span style=color:#f8f8f2>docker</span> <span style=color:#f8f8f2>rm</span> <span style=color:#e6db74>`docker ps -q -n=1`</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f8f8f2>\</span>
		<span style=color:#f8f8f2>docker</span> <span style=color:#f8f8f2>build</span> <span style=color:#f92672>--</span><span style=color:#f8f8f2>rm</span> <span style=color:#f92672>--</span><span style=color:#f8f8f2>tag</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f8f8f2>{</span><span style=color:#66d9ef>NAMESPACE</span><span style=color:#f8f8f2>}</span><span style=color:#e6db74>:latest</span> <span style=color:#f92672>--</span><span style=color:#f8f8f2>file</span> <span style=color:#f92672>.</span><span style=color:#f8f8f2>/</span><span style=color:#66d9ef>Dockerfile</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>static</span> <span style=color:#f92672>.</span>

<span style=color:#e6db74>gobuild</span><span style=color:#f8f8f2>:</span>
	<span style=color:#66d9ef>for</span> <span style=color:#f8f8f2>program</span> <span style=color:#66d9ef>in</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f8f8f2>(</span><span style=color:#66d9ef>PROGRAMS</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>;</span> <span style=color:#66d9ef>do</span> <span style=color:#f8f8f2>\</span>
		<span style=color:#66d9ef>CGO_ENABLED</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>GOOS</span><span style=color:#f92672>=</span><span style=color:#f8f8f2>linux</span> <span style=color:#f8f8f2>go</span> <span style=color:#f8f8f2>build</span> <span style=color:#f92672>--</span><span style=color:#f8f8f2>ldflags</span><span style=color:#f92672>=</span><span style=color:#e6db74>&quot;-s&quot;</span> <span style=color:#f92672>-</span><span style=color:#f8f8f2>a</span> <span style=color:#f92672>-</span><span style=color:#f8f8f2>installsuffix</span> <span style=color:#f8f8f2>cgo</span> <span style=color:#f8f8f2>\</span>
			<span style=color:#f92672>-</span><span style=color:#f8f8f2>o</span> <span style=color:#f8f8f2>$${program}</span> <span style=color:#f92672>.</span><span style=color:#f8f8f2>/go</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>src</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>github</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>com</span><span style=color:#f92672>/</span><span style=color:#66d9ef>MarioCarrion</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>go</span><span style=color:#f92672>-</span><span style=color:#f8f8f2>makefiles</span><span style=color:#f92672>-</span><span style=color:#f8f8f2>skeleton</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>cmd</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>$${program};</span> <span style=color:#f8f8f2>\</span>
	<span style=color:#f8f8f2>done</span>
</code></pre></div><p>The important bit is the <code>PROGRAMS</code> variable, which is currently hardcoded to the existing directories in <code>cmd/</code> that represent the Go programs to be built. Could we get this variable from the output of a simple <code>ls</code>? Yes, definitely.<p>Another important part of this build is the <a href=https://github.com/MarioCarrion/go-makefiles-skeleton/blob/master/Dockerfile.static>static Dockerfile</a>:<p><div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#75715e># vim: set syntax=dockerfile:</span>
<span style=color:#66d9ef>FROM</span> <span style=color:#f8f8f2>tianon</span><span style=color:#f92672>/</span><span style=color:#66d9ef>true</span>

<span style=color:#66d9ef>MAINTAINER</span> <span style=color:#66d9ef>Mario</span> <span style=color:#66d9ef>Carrion</span> <span style=color:#e6db74>&quot;info@xyz&quot;</span>

<span style=color:#66d9ef>COPY</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&quot;hello&quot;</span><span style=color:#f8f8f2>,</span> <span style=color:#f8f8f2>\</span>
      <span style=color:#e6db74>&quot;something&quot;</span><span style=color:#f8f8f2>,</span> <span style=color:#f8f8f2>\</span>
      <span style=color:#e6db74>&quot;/app/&quot;</span><span style=color:#f92672>]</span>

<span style=color:#66d9ef>ENTRYPOINT</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&quot;/app/hello&quot;</span><span style=color:#f92672>]</span>
<span style=color:#66d9ef>CMD</span> <span style=color:#f92672>[]</span>
</code></pre></div><p>Again, similar to the Makefile it hardcodes the files to be copied.<p>In the end those are the two caveats of this process, you have to explicitly add the programs to both files in order to correctly build the whole thing, I&rsquo;ll think about a better alternative and as soon as I have a fix for this, I&rsquo;ll blog about it for sure.<br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>