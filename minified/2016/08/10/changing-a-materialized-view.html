<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Mario Carrion"><meta name=description content="What are the best practices when making changes to a column used by a"><meta property="og:title" content="Tip: Materialized Views: modifying columns with Scenic"><meta property="og:description" content="What are the best practices when making changes to a column used by a"><meta property="og:type" content="article"><meta property="og:url" content="https://www.mariocarrion.com/2016/08/10/changing-a-materialized-view.html"><meta property="article:published_time" content="2016-08-10T00:00:00&#43;00:00"><meta property="article:modified_time" content="2016-08-10T00:00:00&#43;00:00"><title>Tip: Materialized Views: modifying columns with Scenic</title><link rel=canonical href=https://www.mariocarrion.com/2016/08/10/changing-a-materialized-view.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Tip: Materialized Views: modifying columns with Scenic</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Wed Aug 10 2016 00:00:00 UTC">Aug 10, 2016</div></div></div><div class=markdown><p>Back in February I wrote about <a href=/2016/02/26/sharing-models-between-projects.html>Sharing ActiveRecord models between different projects using ActiveRecord</a> by using a combination of Rails and <a href=https://github.com/thoughtbot/scenic>Scenic</a>.<p>Well, what happens when you need to change the column type of one of the tables used by a Materialized View. How do you do that? Using the <a href=https://github.com/MarioCarrion/share-activerecord-models>example I already have on github</a>, and assuming you want to change <strong>products.name</strong> from <code>string</code> to <code>text</code>, you would need generate a migration:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>rails</span> <span style=color:#f8f8f2>g</span> <span style=color:#f8f8f2>migration</span> <span style=color:#f8f8f2>change_products_name</span>
</code></pre></div><p>With the following content:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ChangeProductsName</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Migration</span>
  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>up</span>
    <span style=color:#f8f8f2>drop_view</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>materialized</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>

    <span style=color:#f8f8f2>change_column</span> <span style=color:#e6db74>:products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:name</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:text</span>

    <span style=color:#f8f8f2>create_view</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>materialized</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>

    <span style=color:#75715e># If we had more versions for this materialized we would use the latest</span>
    <span style=color:#75715e># generated instruction, something like:</span>
    <span style=color:#75715e>#</span>
    <span style=color:#75715e># update_view :expensive_products, version: 2, revert_to_version: 1, materialized: true</span>

    <span style=color:#f8f8f2>add_index</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:id</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>unique</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>down</span>
    <span style=color:#f8f8f2>drop_view</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>materialized</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>

    <span style=color:#f8f8f2>change_column</span> <span style=color:#e6db74>:products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:name</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:string</span>

    <span style=color:#f8f8f2>create_view</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>materialized</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>

    <span style=color:#75715e># Similar to &quot;#up&quot; we would do the same:</span>
    <span style=color:#75715e>#</span>
    <span style=color:#75715e># update_view :expensive_products, version: 2, revert_to_version: 1, materialized: true</span>

    <span style=color:#f8f8f2>add_index</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:id</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>unique</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>What is important to take from the code in this migration is how we make the change to update the table and then, after that, we create or update the materialized view, depending on how many versions we already have.<p>The important question about all of this is: <em>Is this the <strong>right way</strong> to do it?</em> This is definitely the way to do it if you don&rsquo;t really have live traffic, or you don&rsquo;t mind getting errors while the database is making the changes.<p>When your system has a lot of traffic you need to be careful and treat your clients with respect, to me the best way to handle a change like this is by doing the following:<ol><li>Create a single migration to add a new column with the right type you want to use to the table.<li>Create a <em>dumpster</em> rake task, to copy the data from the old column to the new one.<li>Update your views, if any, to use this new column.<li>Create a new materialized view, that uses this new column instead of the other one.<li>Update your model and <a href=http://api.rubyonrails.org/classes/ActiveRecord/ModelSchema/ClassMethods.html#method-i-table_name>self.table_name</a> to this new materialized view.<li><strong>Make a release</strong><li>Create a migration similar to the above, making the changes you want.<li>Again, create a <em>dumpster</em> rake task, in this case copy the data from new column to the old one.<li>Again, update your views, if any, to use the old column.<li>Again, update your model to use the old <em>self.table_name</em>.<li><strong>Make a release</strong></ol><p>I know all the steps above seem like overkill, but the truth is that if you&rsquo;re trying to keep your system 100% uptime, with practically zero amount of errors and number of user complaints, that&rsquo;s the only way to do it, basically:<ol><li>Create an intermediary<li>Migrate<li>Revert</ol><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>