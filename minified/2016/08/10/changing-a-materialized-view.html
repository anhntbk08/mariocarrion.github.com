<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - Tip: Materialized Views: modifying columns with Scenic</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2016/08/10/changing-a-materialized-view.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2016>All posts in 2016</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>Aug 10, 2016
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>Tip: Materialized Views: modifying columns with Scenic</h1><div id=post><p>Back in February I wrote about <a href=/2016/02/26/sharing-models-between-projects.html>Sharing ActiveRecord models between different projects using ActiveRecord</a> by using a combination of Rails and <a href=https://github.com/thoughtbot/scenic>Scenic</a>.<p>Well, what happens when you need to change the column type of one of the tables used by a Materialized View. How do you do that? Using the <a href=https://github.com/MarioCarrion/share-activerecord-models>example I already have on github</a>, and assuming you want to change <strong>products.name</strong> from <code>string</code> to <code>text</code>, you would need generate a migration:<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#f8f8f2>rails</span> <span style=color:#f8f8f2>g</span> <span style=color:#f8f8f2>migration</span> <span style=color:#f8f8f2>change_products_name</span>
</pre></div><p>With the following content:<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ChangeProductsName</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Migration</span>
  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>up</span>
    <span style=color:#f8f8f2>drop_view</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>materialized</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>

    <span style=color:#f8f8f2>change_column</span> <span style=color:#e6db74>:products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:name</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:text</span>

    <span style=color:#f8f8f2>create_view</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>materialized</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>

    <span style=color:#75715e># If we had more versions for this materialized we would use the latest</span>
    <span style=color:#75715e># generated instruction, something like:</span>
    <span style=color:#75715e>#</span>
    <span style=color:#75715e># update_view :expensive_products, version: 2, revert_to_version: 1, materialized: true</span>

    <span style=color:#f8f8f2>add_index</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:id</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>unique</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>down</span>
    <span style=color:#f8f8f2>drop_view</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>materialized</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>

    <span style=color:#f8f8f2>change_column</span> <span style=color:#e6db74>:products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:name</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:string</span>

    <span style=color:#f8f8f2>create_view</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>materialized</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>

    <span style=color:#75715e># Similar to &quot;#up&quot; we would do the same:</span>
    <span style=color:#75715e>#</span>
    <span style=color:#75715e># update_view :expensive_products, version: 2, revert_to_version: 1, materialized: true</span>

    <span style=color:#f8f8f2>add_index</span> <span style=color:#e6db74>:expensive_products</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:id</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>unique</span><span style=color:#f8f8f2>:</span> <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</pre></div><p>What is important to take from the code in this migration is how we make the change to update the table and then, after that, we create or update the materialized view, depending on how many versions we already have.<p>The important question about all of this is: <em>Is this the <strong>right way</strong> to do it?</em> This is definitely the way to do it if you don&rsquo;t really have live traffic, or you don&rsquo;t mind getting errors while the database is making the changes.<p>When your system has a lot of traffic you need to be careful and treat your clients with respect, to me the best way to handle a change like this is by doing the following:<ol><li>Create a single migration to add a new column with the right type you want to use to the table.<li>Create a <em>dumpster</em> rake task, to copy the data from the old column to the new one.<li>Update your views, if any, to use this new column.<li>Create a new materialized view, that uses this new column instead of the other one.<li>Update your model and <a href=http://api.rubyonrails.org/classes/ActiveRecord/ModelSchema/ClassMethods.html#method-i-table_name>self.table_name</a> to this new materialized view.<li><strong>Make a release</strong><li>Create a migration similar to the above, making the changes you want.<li>Again, create a <em>dumpster</em> rake task, in this case copy the data from new column to the old one.<li>Again, update your views, if any, to use the old column.<li>Again, update your model to use the old <em>self.table_name</em>.<li><strong>Make a release</strong></ol><p>I know all the steps above seem like overkill, but the truth is that if you&rsquo;re trying to keep your system 100% uptime, with practically zero amount of errors and number of user complaints, that&rsquo;s the only way to do it, basically:<ol><li>Create an intermediary<li>Migrate<li>Revert</ol></div><div id=related><h3>Posts</h3><ul class=posts><li><span>All in 2016!</span> <a href=/archive.html#2016>All posts from this year</a></ul><ul class=posts><li><span>Aug 02, 2016</span> <a href=http://www.mariocarrion.com/2016/08/02/amazon-web-services-in-action.html>Finished Reading: Amazon Web Services in Action</a><li><span>Aug 24, 2016</span> <a href=http://www.mariocarrion.com/2016/08/24/git-workflow.html>Git Workflow: Branches naming conventions</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div>analytics