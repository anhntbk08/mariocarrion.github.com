<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - Tip: From MySQL to PostgreSQL</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2016/01/22/fixing-mysql-postgresql-upgrades.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2016>All posts in 2016</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>Jan 22, 2016
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>Tip: From MySQL to PostgreSQL</h1><div id=post><p>Recents projects are involving migrating from MySQL to PostgreSQL for all the databases including those used in Rails and Reporting.<p>I personally like this change a lot but there a few things I had to remember when changing between MySQL and PostgreSQL, I&rsquo;ll enumerate those.<h3 id=mysql-upgrade-error>MySQL Upgrade Error</h3><p>Not really related to a <em>MySQL-&gt;PostgreSQL</em> migration but more a thing I encounter from time to time when upgrading my local MySQL version, specifically after doing the usual <code>brew upgrade</code>.<p>This is an error when connecting to MySQL, that happens if you use a GUI, for example <a href=https://www.mysql.com/products/workbench/>MySQL Workbench</a> or <a href=http://www.sequelpro.com/>Sequel Pro</a>. The error says:<p><code>Table 'performance_schema.session_variables' doesn't exist</code><p>This is easy to fix, nothing really crazy, just execute:<p><code>mysql_upgrade -u root -p --force</code><h3 id=postgresql-upgrade-error>PostgreSQL Upgrade Error</h3><p>Similar to the MySQL Upgrade Error above, PostgreSQL also complains after upgrading to a major version. For example when I upgraded from 9.4 to 9.5. The error I got was:<blockquote><p>FATAL: database files are incompatible with server
DETAIL: The data directory was initialized by PostgreSQL version 9.4, which is not compatible with this version 9.5.0.</blockquote><p>This one requires a little bit more, but is also easy to fix. Obviously the paths I&rsquo;m using here depend on your actual installation, but if you are also a Homebrew user, then figuring those out shouldn&rsquo;t be that difficult:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>mv <span style=color:#e6db74>/usr/</span>local<span style=color:#e6db74>/var/</span>postgres <span style=color:#e6db74>/usr/</span>local<span style=color:#e6db74>/var/</span>postgres945
initdb <span style=color:#e6db74>/usr/</span>local<span style=color:#e6db74>/var/</span>postgres <span style=color:#f92672>-</span>E utf8
pg_upgrade <span style=color:#f92672>-</span>b <span style=color:#e6db74>/usr/</span>local<span style=color:#e6db74>/Cellar/</span>postgresql<span style=color:#e6db74>/9.4.5/</span>bin <span style=color:#f92672>-</span>B <span style=color:#e6db74>/usr/</span>local<span style=color:#e6db74>/Cellar/</span>postgresql<span style=color:#e6db74>/9.5.0/</span>bin <span style=color:#f92672>-</span>d <span style=color:#e6db74>/usr/</span>local<span style=color:#e6db74>/var/</span>postgres945 <span style=color:#f92672>-</span>D <span style=color:#e6db74>/usr/</span>local<span style=color:#e6db74>/var/</span>postgres</code></pre></div><h3 id=mysql-to-postgresql-rails-database-migration>MySQL to PostgreSQL Rails Database Migration</h3><p>Lastly, another common thing I have to deal a lot with while doing this migration is the <strong>actual</strong> database migration, then execute some ALTERS here and here to use the real types and import the data.<p>There are lot of ways to do this, like you could go all fancy and use something like <a href=https://aws.amazon.com/dms/>AWS&rsquo; DMS</a> or you could follow my poor&rsquo;s man way of doing it.<p>Basically I use <a href=https://github.com/AnatolyUss/FromMySqlToPostgreSql>FromMySqlToPostgreSql</a>, which is a command line script written in PHP, that not only converts the types but also imports the data and honestly is dead easy to use. The only requirement is a recent PHP Cli version. Just follow the instructions for installing PHP in Homebrew from the <a href=https://github.com/Homebrew/homebrew-php>official repo</a> and then do:<p><code>brew install php54-pdo-pgsql</code><p>Make sure your <code>.bashrc</code> includes:<p><code>export PATH=&quot;$(brew --prefix homebrew/php/php54)/bin:$PATH&quot;</code><p>And you&rsquo;re all set regarding the schemas and database content, however one missing thing in this is the conversion of some of the columns to the real PostgreSQL type. Specifically the <code>tinyint</code> that ActiveRecord has to use for representing boolean values.<p>This is easy to do with the following Rake task, obviously using the MySQL database:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>namespace <span style=color:#e6db74>:pg</span> <span style=color:#66d9ef>do</span>

  desc <span style=color:#e6db74>&#39;Creates ALTER statements to convert from mysql:tinyint to pg:boolean&#39;</span>
  task <span style=color:#e6db74>create_alters</span>: <span style=color:#e6db74>:environment</span> <span style=color:#66d9ef>do</span>
    filename <span style=color:#f92672>=</span> <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>root<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;pg_alter_</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>to_i<span style=color:#e6db74>}</span><span style=color:#e6db74>.sql&#34;</span>)

    <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>open(filename, <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>file<span style=color:#f92672>|</span>
      <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span><span style=color:#f92672>.</span>connection<span style=color:#f92672>.</span>tables<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>table<span style=color:#f92672>|</span>
        <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span><span style=color:#f92672>.</span>connection<span style=color:#f92672>.</span>columns(table)<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>column<span style=color:#f92672>|</span>
          <span style=color:#66d9ef>next</span> <span style=color:#66d9ef>unless</span> column<span style=color:#f92672>.</span>type <span style=color:#f92672>==</span> <span style=color:#e6db74>:boolean</span>

          file<span style=color:#f92672>.</span>write <span style=color:#e6db74>&#34;-- Table: </span><span style=color:#e6db74>#{</span>table<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
          file<span style=color:#f92672>.</span>write build_alter_statements(table, column)
          file<span style=color:#f92672>.</span>write <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
        <span style=color:#66d9ef>end</span>
      <span style=color:#66d9ef>end</span>
    <span style=color:#66d9ef>end</span>

    puts <span style=color:#e6db74>&#34;Output file: </span><span style=color:#e6db74>#{</span>filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
  <span style=color:#66d9ef>end</span>

 <span style=color:#66d9ef>def</span> <span style=color:#a6e22e></span><span style=color:#f92672></span><span style=color:#a6e22e>build_alter_statements</span>(table, column)
    default_value <span style=color:#f92672>=</span> (column<span style=color:#f92672>.</span>default<span style=color:#f92672>.</span>to_i <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;TRUE&#39;</span> : <span style=color:#e6db74>&#39;FALSE&#39;</span>)

    <span style=color:#e6db74>&lt;&lt;-SQL
</span><span style=color:#e6db74></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#75715e>#{table} ALTER COLUMN #{column.name} DROP DEFAULT;</span>
<span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#75715e>#{table} ALTER #{column.name} TYPE bool USING CASE WHEN #{column.name}=1 THEN TRUE ELSE FALSE END;</span>
<span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#75715e>#{table} ALTER COLUMN #{column.name} SET DEFAULT #{default_value};</span>

    <span style=color:#66d9ef>SQL</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span></code></pre></div><p>By executing<p><code>rake pg: create_alters</code><p>You should be able to get a file in your Rails root that contains all the right <code>ALTER</code> statements for properly converting the <code>tinyint</code>s to <code>boolean</code>s.</div><div id=related><h3>Posts</h3><ul class=posts><li><a href=/archive.html#2016>All posts this year 2016</a></ul><ul class=posts><li><span>Jul 18, 2015</span> <a href=http://www.mariocarrion.com/2015/07/18/dynamic-models-in-active-record.html>Tip: Dynamic Models in ActiveRecord with PostgreSQL</a><li><span>Jan 26, 2016</span> <a href=http://www.mariocarrion.com/2016/01/26/a-look-back-at-previous-lustrum.html>A look back at the previous lustrum.</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-75640250-1','auto');ga('send','pageview');</script>