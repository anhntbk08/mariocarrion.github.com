<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Mario Carrion"><meta name=description content="Recents projects are involving migrating from MySQL to PostgreSQL for all the databases including those used in Rails and Reporting.
I personally like this change a lot but there a few things I had to remember when changing between MySQL and PostgreSQL, I&rsquo;ll enumerate those.
MySQL Upgrade Error Not really related to a MySQL-&gt;PostgreSQL migration but more a thing I encounter from time to time when upgrading my local MySQL version, specifically after doing the usual brew upgrade."><meta property="og:title" content="Tip: From MySQL to PostgreSQL"><meta property="og:description" content="Recents projects are involving migrating from MySQL to PostgreSQL for all the databases including those used in Rails and Reporting.
I personally like this change a lot but there a few things I had to remember when changing between MySQL and PostgreSQL, I&rsquo;ll enumerate those.
MySQL Upgrade Error Not really related to a MySQL-&gt;PostgreSQL migration but more a thing I encounter from time to time when upgrading my local MySQL version, specifically after doing the usual brew upgrade."><meta property="og:type" content="article"><meta property="og:url" content="https://www.mariocarrion.com/2016/01/22/fixing-mysql-postgresql-upgrades.html"><meta property="article:published_time" content="2016-01-22T00:00:00&#43;00:00"><meta property="article:modified_time" content="2016-01-22T00:00:00&#43;00:00"><title>Tip: From MySQL to PostgreSQL</title><link rel=canonical href=https://www.mariocarrion.com/2016/01/22/fixing-mysql-postgresql-upgrades.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Tip: From MySQL to PostgreSQL</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Fri Jan 22 2016 00:00:00 UTC">Jan 22, 2016</div></div></div><div class=markdown><p>Recents projects are involving migrating from MySQL to PostgreSQL for all the databases including those used in Rails and Reporting.<p>I personally like this change a lot but there a few things I had to remember when changing between MySQL and PostgreSQL, I&rsquo;ll enumerate those.<h3 id=mysql-upgrade-error>MySQL Upgrade Error</h3><p>Not really related to a <em>MySQL-&gt;PostgreSQL</em> migration but more a thing I encounter from time to time when upgrading my local MySQL version, specifically after doing the usual <code>brew upgrade</code>.<p>This is an error when connecting to MySQL, that happens if you use a GUI, for example <a href=https://www.mysql.com/products/workbench/>MySQL Workbench</a> or <a href=http://www.sequelpro.com/>Sequel Pro</a>. The error says:<p><code>Table 'performance_schema.session_variables' doesn't exist</code><p>This is easy to fix, nothing really crazy, just execute:<p><code>mysql_upgrade -u root -p --force</code><h3 id=postgresql-upgrade-error>PostgreSQL Upgrade Error</h3><p>Similar to the MySQL Upgrade Error above, PostgreSQL also complains after upgrading to a major version. For example when I upgraded from 9.4 to 9.5. The error I got was:<blockquote><p>FATAL: database files are incompatible with server
DETAIL: The data directory was initialized by PostgreSQL version 9.4, which is not compatible with this version 9.5.0.</blockquote><p>This one requires a little bit more, but is also easy to fix. Obviously the paths I&rsquo;m using here depend on your actual installation, but if you are also a Homebrew user, then figuring those out shouldn&rsquo;t be that difficult:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>mv</span> <span style=color:#e6db74>/usr/</span><span style=color:#f8f8f2>local</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>var</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>postgres</span> <span style=color:#e6db74>/usr/</span><span style=color:#f8f8f2>local</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>var</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>postgres945</span>
<span style=color:#f8f8f2>initdb</span> <span style=color:#e6db74>/usr/</span><span style=color:#f8f8f2>local</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>var</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>postgres</span> <span style=color:#f92672>-</span><span style=color:#f8f8f2>E</span> <span style=color:#f8f8f2>utf8</span>
<span style=color:#f8f8f2>pg_upgrade</span> <span style=color:#f92672>-</span><span style=color:#f8f8f2>b</span> <span style=color:#e6db74>/usr/</span><span style=color:#f8f8f2>local</span><span style=color:#f92672>/</span><span style=color:#66d9ef>Cellar</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>postgresql</span><span style=color:#f92672>/</span><span style=color:#ae81ff>9</span><span style=color:#f92672>.</span><span style=color:#ae81ff>4</span><span style=color:#f92672>.</span><span style=color:#ae81ff>5</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>bin</span> <span style=color:#f92672>-</span><span style=color:#f8f8f2>B</span> <span style=color:#e6db74>/usr/</span><span style=color:#f8f8f2>local</span><span style=color:#f92672>/</span><span style=color:#66d9ef>Cellar</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>postgresql</span><span style=color:#f92672>/</span><span style=color:#ae81ff>9</span><span style=color:#f92672>.</span><span style=color:#ae81ff>5</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>bin</span> <span style=color:#f92672>-</span><span style=color:#f8f8f2>d</span> <span style=color:#e6db74>/usr/</span><span style=color:#f8f8f2>local</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>var</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>postgres945</span> <span style=color:#f92672>-</span><span style=color:#f8f8f2>D</span> <span style=color:#e6db74>/usr/</span><span style=color:#f8f8f2>local</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>var</span><span style=color:#f92672>/</span><span style=color:#f8f8f2>postgres</span>
</code></pre></div><h3 id=mysql-to-postgresql-rails-database-migration>MySQL to PostgreSQL Rails Database Migration</h3><p>Lastly, another common thing I have to deal a lot with while doing this migration is the <strong>actual</strong> database migration, then execute some ALTERS here and here to use the real types and import the data.<p>There are lot of ways to do this, like you could go all fancy and use something like <a href=https://aws.amazon.com/dms/>AWS&rsquo; DMS</a> or you could follow my poor&rsquo;s man way of doing it.<p>Basically I use <a href=https://github.com/AnatolyUss/FromMySqlToPostgreSql>FromMySqlToPostgreSql</a>, which is a command line script written in PHP, that not only converts the types but also imports the data and honestly is dead easy to use. The only requirement is a recent PHP Cli version. Just follow the instructions for installing PHP in Homebrew from the <a href=https://github.com/Homebrew/homebrew-php>official repo</a> and then do:<p><code>brew install php54-pdo-pgsql</code><p>Make sure your <code>.bashrc</code> includes:<p><code>export PATH=&quot;$(brew --prefix homebrew/php/php54)/bin:$PATH&quot;</code><p>And you&rsquo;re all set regarding the schemas and database content, however one missing thing in this is the conversion of some of the columns to the real PostgreSQL type. Specifically the <code>tinyint</code> that ActiveRecord has to use for representing boolean values.<p>This is easy to do with the following Rake task, obviously using the MySQL database:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>namespace</span> <span style=color:#e6db74>:pg</span> <span style=color:#66d9ef>do</span>

  <span style=color:#f8f8f2>desc</span> <span style=color:#e6db74>&#39;Creates ALTER statements to convert from mysql:tinyint to pg:boolean&#39;</span>
  <span style=color:#f8f8f2>task</span> <span style=color:#e6db74>create_alters</span><span style=color:#f8f8f2>:</span> <span style=color:#e6db74>:environment</span> <span style=color:#66d9ef>do</span>
    <span style=color:#f8f8f2>filename</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>root</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>join(</span><span style=color:#e6db74>&quot;pg_alter_#{</span><span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>now</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to_i</span><span style=color:#e6db74>}.sql&quot;</span><span style=color:#f8f8f2>)</span>

    <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>open(filename,</span> <span style=color:#e6db74>&#39;w&#39;</span><span style=color:#f8f8f2>)</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>file</span><span style=color:#f92672>|</span>
      <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>connection</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>tables</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>each</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>table</span><span style=color:#f92672>|</span>
        <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>connection</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>columns(table)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>each</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>column</span><span style=color:#f92672>|</span>
          <span style=color:#66d9ef>next</span> <span style=color:#66d9ef>unless</span> <span style=color:#f8f8f2>column</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>:boolean</span>

          <span style=color:#f8f8f2>file</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>write</span> <span style=color:#e6db74>&quot;-- Table: #{</span><span style=color:#f8f8f2>table</span><span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&quot;</span>
          <span style=color:#f8f8f2>file</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>write</span> <span style=color:#f8f8f2>build_alter_statements(table,</span> <span style=color:#f8f8f2>column)</span>
          <span style=color:#f8f8f2>file</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>write</span> <span style=color:#e6db74>&quot;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&quot;</span>
        <span style=color:#66d9ef>end</span>
      <span style=color:#66d9ef>end</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#f8f8f2>puts</span> <span style=color:#e6db74>&quot;Output file: #{</span><span style=color:#f8f8f2>filename</span><span style=color:#e6db74>}&quot;</span>
  <span style=color:#66d9ef>end</span>

 <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>build_alter_statements</span><span style=color:#f8f8f2>(table,</span> <span style=color:#f8f8f2>column)</span>
    <span style=color:#f8f8f2>default_value</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>(column</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>default</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to_i</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;TRUE&#39;</span> <span style=color:#f8f8f2>:</span> <span style=color:#e6db74>&#39;FALSE&#39;</span><span style=color:#f8f8f2>)</span>

    <span style=color:#f92672>&lt;&lt;-</span><span style=color:#e6db74>SQL</span>
<span style=color:#e6db74>ALTER TABLE #{table} ALTER COLUMN #{column.name} DROP DEFAULT;</span>
<span style=color:#e6db74>ALTER TABLE #{table} ALTER #{column.name} TYPE bool USING CASE WHEN #{column.name}=1 THEN TRUE ELSE FALSE END;</span>
<span style=color:#e6db74>ALTER TABLE #{table} ALTER COLUMN #{column.name} SET DEFAULT #{default_value};</span>

<span style=color:#e6db74>    SQL</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>By executing<p><code>rake pg: create_alters</code><p>You should be able to get a file in your Rails root that contains all the right <code>ALTER</code> statements for properly converting the <code>tinyint</code>s to <code>boolean</code>s.</p><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>