<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content="Mario Carrion"><meta name=description content="If you interact with any web-based service you need to mock your requests to properly test you program. In reality there are two ways of mocking your external requests:
 You save the response, for example using something like VCR, or You mock the request using something like Webmock API.  Save response using VCR VCR is a really cool gem, it allows you to replay whatever HTTP interactions you had the first time you invoked it, the idea is to always have the same response no matter what, because you actually save the resulting response into a file, a cassette."><meta property=og:title content="Tip: Mocking Web APIs"><meta property=og:description content="If you interact with any web-based service you need to mock your requests to properly test you program. In reality there are two ways of mocking your external requests:
 You save the response, for example using something like VCR, or You mock the request using something like Webmock API.  Save response using VCR VCR is a really cool gem, it allows you to replay whatever HTTP interactions you had the first time you invoked it, the idea is to always have the same response no matter what, because you actually save the resulting response into a file, a cassette."><meta property=og:type content=article><meta property=og:url content=https://www.mariocarrion.com/2016/03/15/mocking-apis.html><meta property=article:published_time content=2016-03-15T00:00:00&#43;00:00><meta property=article:modified_time content=2016-03-15T00:00:00&#43;00:00><title>Tip: Mocking Web APIs</title><link rel=canonical href=https://www.mariocarrion.com/2016/03/15/mocking-apis.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class=main><div class=container><div class=content><div class=page-heading>Tip: Mocking Web APIs</div><div class=markdown><p>If you interact with any web-based service you need to mock your requests to properly test you program. In reality there are two ways of mocking your external requests:<ol><li>You <em>save</em> the response, for example using something like <a href=https://github.com/vcr/vcr>VCR</a>, or<li>You <em>mock</em> the request using something like <a href=https://github.com/bblimke/webmock>Webmock API</a>.</ol><h2 id=save-response-using-vcr>Save response using VCR</h2><p>VCR is a really cool gem, it allows you to <em>replay</em> whatever HTTP interactions you had the first time you invoked it, the idea is to always have the same response no matter what, because you actually save the resulting response into a file, a <em>cassette</em>.<p>The configuration, in this case using webmock as the stubbing facility, is something like this,<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure_rspec_metadata!</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>cassette_library_dir</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>expand_path(</span><span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>join(</span><span style=color:#e6db74>&#39;..&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>&#39;cassettes&#39;</span><span style=color:#f8f8f2>),</span>
                                                 <span style=color:#f8f8f2>__FILE__)</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>hook_into</span> <span style=color:#e6db74>:webmock</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Obviously your specific <code>cassette_library_dir</code> depends on your context, but you get the idea.<p>In Rspec, to use it, you would do something like this:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>describe</span> <span style=color:#e6db74>&#39;#some_method&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>vcr</span><span style=color:#f8f8f2>:</span> <span style=color:#f8f8f2>{</span> <span style=color:#e6db74>cassette_name</span><span style=color:#f8f8f2>:</span> <span style=color:#e6db74>&#39;my_request&#39;</span> <span style=color:#f8f8f2>}</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>it</span> <span style=color:#e6db74>&#39;here I request whatever url I need to&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#75715e># fun stuff</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>This spec will create a file <code>my_request.yml</code> that will contain all the HTTP information requested the time it was executed, including the actual response, and it will use this same file to mock the HTTP objects required to run your tests, so it will always give you the same response.<h2 id=mock-response-using-webmock>Mock response using Webmock</h2><p>In cases where you actually don&rsquo;t have a predefined URL to request, because maybe your program handles responses differently depending on the response code, you would need to explicitly mock this request. For that you need to use webmock directly.<p>Enabling webmock in this case is a little bit more elaborated than using VCR, but still not that complicated. You would need to do three things:<h3 id=1-implement-a-sinatra-application-that-handles-the-actual-request>1. Implement a Sinatra Application that handles the actual request</h3><div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>require</span> <span style=color:#e6db74>&#39;sinatra/base&#39;</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DummyApp</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>Sinatra</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
  <span style=color:#f8f8f2>get</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#e6db74>&#39;hello&#39;</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><h3 id=2-configure-rspec-to-stub-specific-domains-with-that-sinatra-application>2. Configure RSpec to stub specific domains with that Sinatra application</h3><div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#66d9ef>RSpec</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>include</span> <span style=color:#66d9ef>WebMock</span><span style=color:#f92672>::</span><span style=color:#66d9ef>API</span>

  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>before(</span><span style=color:#e6db74>:each</span><span style=color:#f8f8f2>)</span> <span style=color:#66d9ef>do</span>
    <span style=color:#f8f8f2>stub_request(</span><span style=color:#e6db74>:any</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>/mocked-domain.com/</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to_rack(</span><span style=color:#66d9ef>DummyApp</span><span style=color:#f8f8f2>)</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><h3 id=3-use-that-in-your-spec>3. Use that in your spec</h3><div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>describe</span> <span style=color:#e6db74>&#39;#some_method&#39;</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>it</span> <span style=color:#e6db74>&#39;here I request mocked-domain.com/hello&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#75715e># fun stuff</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><h2 id=final-thoughts>Final thoughts</h2><p>Knowing both ways to handle (and mock) external web services is extremely useful because it allows you to have deterministic results. Super useful when building programs around external web services.</div></div></div></section>