<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - Tip: Mocking Web APIs</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2016/03/15/mocking-apis.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2016>All posts in 2016</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>Mar 15, 2016
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>Tip: Mocking Web APIs</h1><div id=post><p>If you interact with any web-based service you need to mock your requests to properly test you program. In reality there are two ways of mocking your external requests:<ol><li>You <em>save</em> the response, for example using something like <a href=https://github.com/vcr/vcr>VCR</a>, or<li>You <em>mock</em> the request using something like <a href=https://github.com/bblimke/webmock>Webmock API</a>.</ol><h2 id=save-response-using-vcr>Save response using VCR</h2><p>VCR is a really cool gem, it allows you to <em>replay</em> whatever HTTP interactions you had the first time you invoked it, the idea is to always have the same response no matter what, because you actually save the resulting response into a file, a <em>cassette</em>.<p>The configuration, in this case using webmock as the stubbing facility, is something like this,<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure_rspec_metadata!</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>cassette_library_dir</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>expand_path(</span><span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>join(</span><span style=color:#e6db74>&#39;..&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>&#39;cassettes&#39;</span><span style=color:#f8f8f2>),</span>
                                                 <span style=color:#f8f8f2>__FILE__)</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>hook_into</span> <span style=color:#e6db74>:webmock</span>
<span style=color:#66d9ef>end</span>
</pre></div><p>Obviously your specific <code>cassette_library_dir</code> depends on your context, but you get the idea.<p>In Rspec, to use it, you would do something like this:<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#f8f8f2>describe</span> <span style=color:#e6db74>&#39;#some_method&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>vcr</span><span style=color:#f8f8f2>:</span> <span style=color:#f8f8f2>{</span> <span style=color:#e6db74>cassette_name</span><span style=color:#f8f8f2>:</span> <span style=color:#e6db74>&#39;my_request&#39;</span> <span style=color:#f8f8f2>}</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>it</span> <span style=color:#e6db74>&#39;here I request whatever url I need to&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#75715e># fun stuff</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</pre></div><p>This spec will create a file <code>my_request.yml</code> that will contain all the HTTP information requested the time it was executed, including the actual response, and it will use this same file to mock the HTTP objects required to run your tests, so it will always give you the same response.<h2 id=mock-response-using-webmock>Mock response using Webmock</h2><p>In cases where you actually don&rsquo;t have a predefined URL to request, because maybe your program handles responses differently depending on the response code, you would need to explicitly mock this request. For that you need to use webmock directly.<p>Enabling webmock in this case is a little bit more elaborated than using VCR, but still not that complicated. You would need to do three things:<h3 id=1-implement-a-sinatra-application-that-handles-the-actual-request>1. Implement a Sinatra Application that handles the actual request</h3><div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#f8f8f2>require</span> <span style=color:#e6db74>&#39;sinatra/base&#39;</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DummyApp</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>Sinatra</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
  <span style=color:#f8f8f2>get</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#e6db74>&#39;hello&#39;</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</pre></div><h3 id=2-configure-rspec-to-stub-specific-domains-with-that-sinatra-application>2. Configure RSpec to stub specific domains with that Sinatra application</h3><div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#66d9ef>RSpec</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>include</span> <span style=color:#66d9ef>WebMock</span><span style=color:#f92672>::</span><span style=color:#66d9ef>API</span>

  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>before(</span><span style=color:#e6db74>:each</span><span style=color:#f8f8f2>)</span> <span style=color:#66d9ef>do</span>
    <span style=color:#f8f8f2>stub_request(</span><span style=color:#e6db74>:any</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>/mocked-domain.com/</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to_rack(</span><span style=color:#66d9ef>DummyApp</span><span style=color:#f8f8f2>)</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</pre></div><h3 id=3-use-that-in-your-spec>3. Use that in your spec</h3><div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#f8f8f2>describe</span> <span style=color:#e6db74>&#39;#some_method&#39;</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>it</span> <span style=color:#e6db74>&#39;here I request mocked-domain.com/hello&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#75715e># fun stuff</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</pre></div><h2 id=final-thoughts>Final thoughts</h2><p>Knowing both ways to handle (and mock) external web services is extremely useful because it allows you to have deterministic results. Super useful when building programs around external web services.</div><div id=related><h3>Posts</h3><ul class=posts><li><span>All in 2016!</span> <a href=/archive.html#2016>All posts from this year</a></ul><ul class=posts><li><span>Mar 09, 2016</span> <a href=http://www.mariocarrion.com/2016/03/09/beyond-blame.html>Finished Reading: Beyond Blame: Learning From Failure and Success</a><li><span>Mar 18, 2016</span> <a href=http://www.mariocarrion.com/2016/03/18/the-compound-effect.html>Finished Reading: The Compound Effect</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-75640250-1','auto');ga('send','pageview');</script>