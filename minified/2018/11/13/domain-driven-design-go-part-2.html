<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content="Mario Carrion"><meta name=description content="DDD &#43; Go: Part 2."><meta property=og:title content="Domain Driven Design and Go: Part 2, Domain Modeling"><meta property=og:description content="DDD &#43; Go: Part 2."><meta property=og:type content=article><meta property=og:url content=https://www.mariocarrion.com/2018/11/13/domain-driven-design-go-part-2.html><meta property=article:published_time content=2018-11-13T00:00:00&#43;00:00><meta property=article:modified_time content=2018-11-13T00:00:00&#43;00:00><title>Domain Driven Design and Go: Part 2, Domain Modeling</title><link rel=canonical href=https://www.mariocarrion.com/2018/11/13/domain-driven-design-go-part-2.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Domain Driven Design and Go: Part 2, Domain Modeling</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Tue Nov 13 2018 00:00:00 UTC">Nov 13, 2018</div></div></div><div class=markdown><h2 id=introduction>Introduction</h2><p><a href=/2018/11/07/domain-driven-design-go-loteria.html>Last time</a> we talked about how awesome <strong>Loter&iacute;a</strong> is and we defined the concrete rules of the game. What&rsquo;s next is not a surprise: we are going to translate those rules. We will convert them into something <em>the machine</em> can understand.<p>Let&rsquo;s go through each rule and &ldquo;translate it&rdquo; to technical terms.<blockquote><p>There is a deck with 54 cards,</blockquote><p>The deck is represented with an array of 54 <code>Card</code>s,<blockquote><p>There are N players, each player is given one <em>Tabla</em> (Board),</blockquote><p>We have N <code>Player</code>s, each of them has one <code>Board</code>, the players can not choose those said boards, they are randomly assigned,<blockquote><p><em>Tablas</em> always have a randomly created 4x4 grid of cards,<p>Given <em>tablas</em> are unique during the duration of the game,</blockquote><p><code>Board</code>s are random and <em>unique</em> per game session, meaning <strong>no player</strong> will be using the same permutation of values on the board of any other board already created,<blockquote><p>There&rsquo;s a <em>Cantor</em> (Announcer), who is in charge of randomly selecting cards from the deck,
Players have to listen to the announced cards and mark them on their boards,</blockquote><p>Those two requirements are really clear, however we still need a bit more of time to provide a better technical implementation. Let&rsquo;s move those to the <em>parking lot</em>.<blockquote><p>The winner is determined by the first player who shouts <strong>&ldquo;LOTER&Iacute;A!&rdquo;</strong> and (<strong>more importantly</strong>) has four sequential marked cards in a horizontal, vertical or diagonal row.</blockquote><p>We need a way to allow the players to <strong>shout</strong> they won and, obviously, we must validate that the result really matches the rules.<h2 id=iteration-1>Iteration #1</h2><p><a href=https://github.com/MarioCarrion/loteria/compare/70c3ce9..c1c937a>Diff implementing this iteration</a>.<p>Initial iteration will consider the following three, of eight, requirements:<ul><li>There is a deck with 54 cards,<li><em>Tablas</em> always have a randomly created 4x4 grid of cards, and<li>The winner has four sequential marked cards in a horizontal, vertical or diagonal row.</ul><h3 id=there-is-a-deck-with-54-cards>There is a deck with 54 cards</h3><p>Defining a <code>Card</code> type should clarify our goal, then we need an array of <code>Card</code>s with a length of 54, or even better we can define a new type <code>Deck</code> to <a href=https://github.com/MarioCarrion/loteria/blob/c1c937ae4556b51284915ae1fa84efe6a2f66edc/card.go#L3-L10>explicitly indicate that</a>:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#66d9ef>type</span> <span style=color:#f8f8f2>(</span>
	<span style=color:#75715e>// Card defines the card, which is part of the board and also announced by</span>
	<span style=color:#75715e>// the caller.</span>
	<span style=color:#a6e22e>Card</span> <span style=color:#66d9ef>uint64</span>

	<span style=color:#75715e>// Deck defines the type containing all the 54 Cards.</span>
	<span style=color:#a6e22e>Deck</span> <span style=color:#f8f8f2>[</span><span style=color:#ae81ff>54</span><span style=color:#f8f8f2>]</span><span style=color:#a6e22e>Card</span>
<span style=color:#f8f8f2>)</span>
</code></pre></div><p>Why is the card <code>uint64</code>? Because this type has 64 bits, which in practice can represent up to 64 different cards, so by using this type we can flag each bit to independently indicate a concrete card per bit; we only need 54 but we support up to 64. That being said&hellip; why <code>uint64</code> instead of <code>int64</code>? Well I personally like working with non negative numbers (not that any of this matters at all in this particular case).<p>Defining the concrete cards is a repetitive exercise, <a href=https://github.com/MarioCarrion/loteria/blob/c1c937ae4556b51284915ae1fa84efe6a2f66edc/card.go#L13-L68>sort of like</a>:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#66d9ef>const</span> <span style=color:#f8f8f2>(</span>
	<span style=color:#a6e22e>RoosterCard</span> <span style=color:#a6e22e>Card</span> <span style=color:#f8f8f2>=</span> <span style=color:#66d9ef>iota</span>
	<span style=color:#a6e22e>DevilCard</span>
	<span style=color:#a6e22e>LadyCard</span>
	<span style=color:#a6e22e>DandyCard</span>
	<span style=color:#75715e>// all other cards ...</span>
<span style=color:#f8f8f2>)</span>
</code></pre></div><h3 id=tablas-always-have-a-randomly-created-4x4-grid-of-cards>Tablas always have a randomly created 4x4 grid of cards</h3><p><code>Board</code>s have 16 <code>Card</code>s, defining them as a concrete type is the way to go because we are going to be interacting with then heavily during our game, so this makes sense:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#66d9ef>type</span> <span style=color:#f8f8f2>(</span>
	<span style=color:#75715e>// Board defines a &quot;tabla&quot;, which is 4x4 grid of 16 Cards.</span>
	<span style=color:#a6e22e>Board</span> <span style=color:#66d9ef>struct</span> <span style=color:#f8f8f2>{</span>
		<span style=color:#a6e22e>cards</span> <span style=color:#66d9ef>map</span><span style=color:#f8f8f2>[</span><span style=color:#a6e22e>Card</span><span style=color:#f8f8f2>]</span><span style=color:#a6e22e>index</span>
	<span style=color:#f8f8f2>}</span>
<span style=color:#f8f8f2>)</span>
</code></pre></div><blockquote><p>Notice there&rsquo;s an <code>index</code> type, I will describe that below.</blockquote><p>What about the <em>randomly created</em> requirement? For that, the best approach would be to create a <a href=https://github.com/MarioCarrion/loteria/blob/c1c937ae4556b51284915ae1fa84efe6a2f66edc/board.go#L38-L51>concrete &ldquo;constructor&rdquo;</a>, like so:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#75715e>// NewRandomBoard returns a board with random Cards.</span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRandomBoard</span><span style=color:#f8f8f2>()</span> <span style=color:#a6e22e>Board</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>New</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>rand</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>NewSource</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>time</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Now</span><span style=color:#f8f8f2>().</span><span style=color:#a6e22e>UnixNano</span><span style=color:#f8f8f2>()))</span>

	<span style=color:#a6e22e>cards</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span><span style=color:#f8f8f2>[</span><span style=color:#a6e22e>Card</span><span style=color:#f8f8f2>]</span><span style=color:#a6e22e>index</span><span style=color:#f8f8f2>{}</span>
	<span style=color:#66d9ef>for</span> <span style=color:#f8f8f2>len(</span><span style=color:#a6e22e>cards</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>&lt;</span> <span style=color:#ae81ff>16</span> <span style=color:#f8f8f2>{</span>
		<span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Intn</span><span style=color:#f8f8f2>(</span><span style=color:#ae81ff>53</span><span style=color:#f8f8f2>)</span>
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span><span style=color:#f8f8f2>,</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cards</span><span style=color:#f8f8f2>[</span><span style=color:#a6e22e>Card</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>v</span><span style=color:#f8f8f2>)];</span> <span style=color:#f8f8f2>!</span><span style=color:#a6e22e>ok</span> <span style=color:#f8f8f2>{</span>
			<span style=color:#a6e22e>cards</span><span style=color:#f8f8f2>[</span><span style=color:#a6e22e>Card</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>v</span><span style=color:#f8f8f2>)]</span> <span style=color:#f8f8f2>=</span> <span style=color:#a6e22e>index</span><span style=color:#f8f8f2>(</span><span style=color:#ae81ff>1</span><span style=color:#f8f8f2>)</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f8f8f2>uint16(len(</span><span style=color:#a6e22e>cards</span><span style=color:#f8f8f2>))</span>
		<span style=color:#f8f8f2>}</span>
	<span style=color:#f8f8f2>}</span>

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Board</span><span style=color:#f8f8f2>{</span><span style=color:#a6e22e>cards</span><span style=color:#f8f8f2>:</span> <span style=color:#a6e22e>cards</span><span style=color:#f8f8f2>}</span>
<span style=color:#f8f8f2>}</span>
</code></pre></div><p>That function above randomizes 16 numbers between 0 and 53 and assigns them to the internal map. One <strong>really important thing</strong> to notice in this function is the value of <code>index</code> in the map, it represents the <em>location</em> of this card in the (to be added) <code>marked</code> attribute. Please continue reading.<h3 id=the-winner-has-four-sequential-marked-cards>The winner has four sequential marked cards</h3><p>This means we require having a way to <em>mark</em> cards on our <code>Board</code>:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#75715e>// Mark marks off the card on the board.</span>
<span style=color:#66d9ef>func</span> <span style=color:#f8f8f2>(</span><span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Board</span><span style=color:#f8f8f2>)</span> <span style=color:#a6e22e>Mark</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>c</span> <span style=color:#a6e22e>Card</span><span style=color:#f8f8f2>)</span> <span style=color:#66d9ef>error</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#a6e22e>index</span><span style=color:#f8f8f2>,</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>cards</span><span style=color:#f8f8f2>[</span><span style=color:#a6e22e>c</span><span style=color:#f8f8f2>]</span>
	<span style=color:#66d9ef>if</span> <span style=color:#f8f8f2>!</span><span style=color:#a6e22e>ok</span> <span style=color:#f8f8f2>{</span>
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrCardNotOnBoard</span>
	<span style=color:#f8f8f2>}</span>

	<span style=color:#a6e22e>b</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>marked</span> <span style=color:#f92672>|=</span> <span style=color:#a6e22e>index</span>

	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
<span style=color:#f8f8f2>}</span>
</code></pre></div><p>The <em>method</em> above introduces the field <a href=https://github.com/MarioCarrion/loteria/blob/c1c937ae4556b51284915ae1fa84efe6a2f66edc/board.go#L11><code>marked</code></a> which was mentioned above, this attribute is used to keep track of the <em>marked</em> cards, using bit flagging. This same field, <code>marked</code>, is also used to determine if the <code>Board</code> is a <a href=https://github.com/MarioCarrion/loteria/blob/664e47f8a428772cef79edb2a0916090090bc475/board.go#L66-L75><em>winning one</em></a>:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#75715e>// Winner indicates whether the marked cards win the game.</span>
<span style=color:#66d9ef>func</span> <span style=color:#f8f8f2>(</span><span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Board</span><span style=color:#f8f8f2>)</span> <span style=color:#a6e22e>Winner</span><span style=color:#f8f8f2>()</span> <span style=color:#66d9ef>bool</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span><span style=color:#f8f8f2>,</span> <span style=color:#a6e22e>pattern</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>defaultWinningPatterns</span> <span style=color:#f8f8f2>{</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f8f8f2>(uint16(</span><span style=color:#a6e22e>b</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>marked</span><span style=color:#f8f8f2>)</span> <span style=color:#f92672>&amp;</span> <span style=color:#f8f8f2>uint16(</span><span style=color:#a6e22e>pattern</span><span style=color:#f8f8f2>))</span> <span style=color:#f92672>==</span> <span style=color:#f8f8f2>uint16(</span><span style=color:#a6e22e>pattern</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span>
			<span style=color:#a6e22e>b</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>WinningPattern</span> <span style=color:#f8f8f2>=</span> <span style=color:#a6e22e>pattern</span>
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
		<span style=color:#f8f8f2>}</span>
	<span style=color:#f8f8f2>}</span>
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
<span style=color:#f8f8f2>}</span>
</code></pre></div><p>Where those <code>defaultWinningPatterns</code> are predefined <a href=https://github.com/MarioCarrion/loteria/blob/664e47f8a428772cef79edb2a0916090090bc475/winning_pattern.go#L9-L24>Winning Patterns</a> we computed in advance.<hr><p>It looks like we made significant progress!! Let’s take a break for now, digest everything and come back tomorrow.<br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>