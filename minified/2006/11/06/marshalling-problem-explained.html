<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content="Mario Carrion"><meta name=description content="I commented this days ago, now here comes the explanation.
The idea is the following, you have to send through sockets a marshalled structure, this structure will be received by socket server written in C. Then, for example I have:
#pragma pack (1)
struct sample {
int index;
int length; /* Indicates value length */
char *value; /* This value might be any value */
};
typedef struct sample sample_t;"><meta property=og:title content="Marshalling problem, explained"><meta property=og:description content="I commented this days ago, now here comes the explanation.
The idea is the following, you have to send through sockets a marshalled structure, this structure will be received by socket server written in C. Then, for example I have:
#pragma pack (1)
struct sample {
int index;
int length; /* Indicates value length */
char *value; /* This value might be any value */
};
typedef struct sample sample_t;"><meta property=og:type content=article><meta property=og:url content=https://www.mariocarrion.com/2006/11/06/marshalling-problem-explained.html><meta property=article:published_time content=2006-11-06T22:22:47&#43;00:00><meta property=article:modified_time content=2006-11-06T22:22:47&#43;00:00><title>Marshalling problem, explained</title><link rel=canonical href=https://www.mariocarrion.com/2006/11/06/marshalling-problem-explained.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Marshalling problem, explained</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Mon Nov 6 2006 22:22:47 UTC">Nov 06, 2006</div></div></div><div class=markdown><p>I commented this <a href=http://mario.monouml.org/index.php/2006/10/30/marshalling-problems-again/>days ago</a>, now here comes the explanation.<p>The idea is the following, you have to send through sockets a marshalled structure, this structure will be received by socket server written in C. Then, for example I have:<p><code lang=c>#pragma pack (1)<br>struct sample {<br>int index;<br>int length; /* Indicates value length */<br>char *value; /* This value might be any value */<br>};<br>typedef struct sample sample_t;<br>#pragma end<br></code><p>That C structure, in C# is, after marshalling:<p><code lang=csharp>[StructLayout (LayoutKind.Sequential, Pack = 1, CharSet = CharSet.Ansi)]<br>public struct Sample<br>{<br>public int Index;<br>public int DataLength;<br>[MarshalAs (UnmanagedType.ByValArray, ArraySubType = UnmanagedType.I1, SizeConst = 1)]<br>public byte []Data;<br>}</code><p>We have our marshalled C# structure. Did you notice the <em>SizeConst</em> value? Well that SizeConst, will, when using <em>Marshal.SizeOf (typeof (Sample))</em>, return a <em>structure known-bytes size</em>. If you are planning to use real-sized structure you MUST marshall them, and there comes the pain. Why? Because you actually need to know about bytes and size of each element send or received by differents processes, in this example, through IP sockets.<p>C structure uses a dynamic array and I want to use it that way. By setting the size to 1 in C# structure forces me to use 1 byte instead. Really problematic isn't it? Until today I haven't yet found the way to do it automatically. My solution is to use <em>Array.Copy</em> to copy the marshalled value (value contained in the <em>byte[]</em>) after the full structure was marshalled, it works, but isn't too fancy, and when using a Structure that contains a byte[] and setting into that byte[] another Structure that also contains byte[] the problems increase because you need to <em>Array.Copy</em> each one of them.<p>By the way, I'm using the <a href=http://groups.google.com/group/microsoft.public.dotnet.languages.csharp/msg/7e43c0f0613adce1>"google solution"</a> to marshall .NET structures to byte[], am not sure who is the original author of the following code, but seems to be solution to convert from any marshalled structure to bytes array, and viceversa:<p><code lang=csharp>public static object RawDeserialize (byte[] rawdatas, Type anytype) {<br>int rawsize = Marshal.SizeOf (anytype);<br>if (rawsize > rawdatas.Length)<br>return null;<br>GCHandle handle = GCHandle.Alloc (rawdatas, GCHandleType.Pinned);<br>IntPtr buffer = handle.AddrOfPinnedObject ();<br>object retobj = Marshal.PtrToStructure (buffer, anytype);<br>handle.Free ();<br>return retobj;<br>}<p>public static byte[] RawSerialize (object anything)<br>{<br>int rawsize = Marshal.SizeOf (anything);<br>byte[] rawdatas = new byte [rawsize];<br>GCHandle handle = GCHandle.Alloc (rawdatas, GCHandleType.Pinned);<br>IntPtr buffer = handle.AddrOfPinnedObject ();<br>Marshal.StructureToPtr (anything, buffer, false);<br>handle.Free ();<br>return rawdatas;<br>}</code><p>Be aware that are some <a href=http://www.mono-project.com/Dllimport>tips&tricks</a> while marshalling and you must follow each one of them. Because we are living in <em>managed world</em> and unmanaged is almost a sin.<br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>