<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - Marshalling problem, explained</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2006/11/06/marshalling-problem-explained.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2006>All posts in 2006</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>Nov 06, 2006
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>Marshalling problem, explained</h1><div id=post><p>I commented this <a href=http://mario.monouml.org/index.php/2006/10/30/marshalling-problems-again/>days ago</a>, now here comes the explanation.<p>The idea is the following, you have to send through sockets a marshalled structure, this structure will be received by socket server written in C. Then, for example I have:<p><code lang=c>#pragma pack (1)<br>struct sample {<br>int index;<br>int length; /* Indicates value length */<br>char *value; /* This value might be any value */<br>};<br>typedef struct sample sample_t;<br>#pragma end<br></code><p>That C structure, in C# is, after marshalling:<p><code lang=csharp>[StructLayout (LayoutKind.Sequential, Pack = 1, CharSet = CharSet.Ansi)]<br>public struct Sample<br>{<br>public int Index;<br>public int DataLength;<br>[MarshalAs (UnmanagedType.ByValArray, ArraySubType = UnmanagedType.I1, SizeConst = 1)]<br>public byte []Data;<br>}</code><p>We have our marshalled C# structure. Did you notice the <em>SizeConst</em> value? Well that SizeConst, will, when using <em>Marshal.SizeOf (typeof (Sample))</em>, return a <em>structure known-bytes size</em>. If you are planning to use real-sized structure you MUST marshall them, and there comes the pain. Why? Because you actually need to know about bytes and size of each element send or received by differents processes, in this example, through IP sockets.<p>C structure uses a dynamic array and I want to use it that way. By setting the size to 1 in C# structure forces me to use 1 byte instead. Really problematic isn't it? Until today I haven't yet found the way to do it automatically. My solution is to use <em>Array.Copy</em> to copy the marshalled value (value contained in the <em>byte[]</em>) after the full structure was marshalled, it works, but isn't too fancy, and when using a Structure that contains a byte[] and setting into that byte[] another Structure that also contains byte[] the problems increase because you need to <em>Array.Copy</em> each one of them.<p>By the way, I'm using the <a href=http://groups.google.com/group/microsoft.public.dotnet.languages.csharp/msg/7e43c0f0613adce1>"google solution"</a> to marshall .NET structures to byte[], am not sure who is the original author of the following code, but seems to be solution to convert from any marshalled structure to bytes array, and viceversa:<p><code lang=csharp>public static object RawDeserialize (byte[] rawdatas, Type anytype) {<br>int rawsize = Marshal.SizeOf (anytype);<br>if (rawsize > rawdatas.Length)<br>return null;<br>GCHandle handle = GCHandle.Alloc (rawdatas, GCHandleType.Pinned);<br>IntPtr buffer = handle.AddrOfPinnedObject ();<br>object retobj = Marshal.PtrToStructure (buffer, anytype);<br>handle.Free ();<br>return retobj;<br>}<p>public static byte[] RawSerialize (object anything)<br>{<br>int rawsize = Marshal.SizeOf (anything);<br>byte[] rawdatas = new byte [rawsize];<br>GCHandle handle = GCHandle.Alloc (rawdatas, GCHandleType.Pinned);<br>IntPtr buffer = handle.AddrOfPinnedObject ();<br>Marshal.StructureToPtr (anything, buffer, false);<br>handle.Free ();<br>return rawdatas;<br>}</code><p>Be aware that are some <a href=http://www.mono-project.com/Dllimport>tips&tricks</a> while marshalling and you must follow each one of them. Because we are living in <em>managed world</em> and unmanaged is almost a sin.</div><div id=related><h3>Posts</h3><ul class=posts><li><span>All in 2016!</span> <a href=/archive.html#2006>All posts from this year</a></ul><ul class=posts><li><span>Nov 04, 2006</span> <a href=http://www.mariocarrion.com/2006/11/04/one-year-2.html>One year</a><li><span>Nov 07, 2006</span> <a href=http://www.mariocarrion.com/2006/11/07/my-idea.html>My idea</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div>analytics