<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Mario Carrion"><meta name=description content="DespuÃ©s de haber hecho lo antes comentado y cambiar las clases por estructuras he notado que (sin la menor duda) se acelara el desempeÃ±o, he bajado la respuesta de 6~8 segundos a menos de un segundo, lo cual es algo grandioso, procesar mÃ¡s de 21000 estructuras de aproxidamente 1500 bytes cada una es fantÃ¡stico, el consumo de CPU es de 1%-3% (hablando de un P4 2.4Ghz), claro que este caso de prueba es &#34;"><meta property="og:title" content="Notas de desempeÃ±o, 2"><meta property="og:description" content="DespuÃ©s de haber hecho lo antes comentado y cambiar las clases por estructuras he notado que (sin la menor duda) se acelara el desempeÃ±o, he bajado la respuesta de 6~8 segundos a menos de un segundo, lo cual es algo grandioso, procesar mÃ¡s de 21000 estructuras de aproxidamente 1500 bytes cada una es fantÃ¡stico, el consumo de CPU es de 1%-3% (hablando de un P4 2.4Ghz), claro que este caso de prueba es &#34;"><meta property="og:type" content="article"><meta property="og:url" content="https://www.mariocarrion.com/2006/05/01/notas-de-desempeno-2.html"><meta property="article:published_time" content="2006-05-01T22:52:22+00:00"><meta property="article:modified_time" content="2006-05-01T22:52:22+00:00"><title>Notas de desempeÃ±o, 2</title><link rel=canonical href=https://www.mariocarrion.com/2006/05/01/notas-de-desempeno-2.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Notas de desempeÃ±o, 2</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Mon May 1 2006 22:52:22 UTC">May 01, 2006</div></div></div><div class=markdown><p>DespuÃ©s de haber hecho lo <a href=http://mario.monouml.org/index.php/2006/04/25/notas-de-desempeno/>antes comentado</a> y cambiar las clases por estructuras he notado que (sin la menor duda) se acelara el desempeÃ±o, he bajado la respuesta de 6~8 segundos a menos de un segundo, lo cual es algo grandioso, procesar mÃ¡s de 21000 estructuras de aproxidamente 1500 bytes cada una es fantÃ¡stico, el consumo de CPU es de 1%-3% (hablando de un P4 2.4Ghz), claro que este caso de prueba es "<em>el peor de los casos</em>" y tambiÃ©n, aÃºn, hay detalles que podrÃ­an ser mejorados, los resultados son excelentes. Durante la recepciÃ³n utilizo la soluciÃ³n del marshalling+cast, de modo que se hace un cast explÃ­cito al tipo de estructura, por ejemplo, suponiendo que tenemos una estructura definida como:<p><code lang=csharp>[StructLayout (LayoutKind.Explicit)]<br>public struct MyStruct<br>{<br>[FieldOffset (0)]<br>public int Integer;<p>[FieldOffset (4)]<br>public short Short;<br>}</code><p>PodrÃ­amos dentro de alguna parte de nuestra lÃ³gica de procesamiento del flujo binario, hacer el cast:<p><code lang=csharp>fixed (byte *data = reader.ReadBytes (sizeof (MyStruct))) {<br>header = *(MyStruct *) data;<br>}</code><p>Donde el flujo lo leemos a travÃ©s de la variable <em>reader</em> (BinaryReader). Lo mÃ¡s probable es que este proceso se encuentre dentro de un ciclo infinito que se encuentra recibiendo la informaciÃ³n del flujo de red. DespuÃ©s de unas pruebas, que hice por simple curiosidad, note algo muy interesante de las formas de obtener el tamaÃ±o de una definiciÃ³n de estructura y clase, lo mÃ¡s sorprendente fue que el mÃ©todo propuesto por "<em>Marshal.SizeOf (typeof (MyStruct))</em>", es mÃ¡s lento, y sin duda es cierto, pues cada ocasiÃ³n que es llamado se realiza un asignaciÃ³n por la CLR para calcular su tamaÃ±o.<pre>repetitions: 1000
iterations: 1.000000e+006

TestSizeOfStatic :      7.773 seconds
TestSizeOf:     2.781 seconds
TestSizeOfMarshal :     50.093 seconds</pre><p>Debido a que sizeof Ãºnicamente sirve para tipos por valor, no es posible aplicar este mÃ©todo a una clase y tendrÃ­amos que utilizar <em>Marshal.SizeOf</em> para obtener este tamaÃ±o, una soluciÃ³n para no afectar el desempeÃ±o y no utilizar siempre la opciÃ³n no recomendada es agregando una propiedad estÃ¡tica a nuestra clase ademÃ¡s de una variable privada estÃ¡tica que mantenga este tamaÃ±o, algo como:<p><code lang=csharp>[StructLayout (LayoutKind.Sequential)]<br>public class MyClass<br>{<br>public int Integer;<br>public short Short;<p>static unsafe MyClass ()<br>{<br>_size = Marshal.SizeOf (typeof (MyClass));<br>}<p>public static int Size<br>{<br>get { return _size; }<br>}<p>private static int _size;<br>}</code><p>AdemÃ¡s hay que recordar que el <em>overhead</em> de utilizar una clase en comparaciÃ³n a una estructura es mayor. Hay detalles en las clases, al igual que en las estructuras, que deben ser consideradas, el <a href=http://www.mono-project.com/Interop_with_Native_Libraries>sitio de mono</a> tiene algunos buenos consejos para esto.</p><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=UA-75640250-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-75640250-1');</script>