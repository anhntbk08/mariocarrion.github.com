<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content="Mario Carrion"><meta name=description content="If you are C programmer you might have noticed the existence of the bit fields in structs:
typedef struct {
int Some : 1;
int Bit : 2;
int Fields : 5;
} MyStruct;
Marshaling that code could be a pain in the ass. Before all, read Jonathan's doc, then forget about the C's sizeof, sum all the bit fields and get the value, in our sample struct we need to get that as 1 byte (1 &#43; 2 &#43; 5 = 8 bits = 1 byte) and then use the System."><meta property=og:title content="Marshaling: C's struct's bit fields"><meta property=og:description content="If you are C programmer you might have noticed the existence of the bit fields in structs:
typedef struct {
int Some : 1;
int Bit : 2;
int Fields : 5;
} MyStruct;
Marshaling that code could be a pain in the ass. Before all, read Jonathan's doc, then forget about the C's sizeof, sum all the bit fields and get the value, in our sample struct we need to get that as 1 byte (1 &#43; 2 &#43; 5 = 8 bits = 1 byte) and then use the System."><meta property=og:type content=article><meta property=og:url content=https://www.mariocarrion.com/2006/01/29/marshaling-cs-struct-bit-fields.html><meta property=article:published_time content=2006-01-29T23:02:40&#43;00:00><meta property=article:modified_time content=2006-01-29T23:02:40&#43;00:00><title>Marshaling: C&#39;s struct&#39;s bit fields</title><link rel=canonical href=https://www.mariocarrion.com/2006/01/29/marshaling-cs-struct-bit-fields.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class=main><div class=container><div class=content><div class=page-heading>Marshaling: C&#39;s struct&#39;s bit fields</div><div class=markdown><p>If you are C programmer you might have noticed the existence of the <em>bit fields</em> in structs:<p><code lang=c>typedef struct {<br>int Some : 1;<br>int Bit : 2;<br>int Fields : 5;<br>} MyStruct;</code><p>Marshaling that code could be a pain in the ass. Before all, read <a href=http://www.jprl.com/interop.html>Jonathan's doc</a>, then forget about the C's sizeof, sum all the bit fields and get the value, in our sample struct we need to get that as 1 byte (<em>1 + 2 + 5 = 8 bits = 1 byte</em>) and then use the <strong>System.Collections.BitArray</strong> class, and convert that to their data type value. (I wrote a wrapper for doing this in a easiest way)<p>See the <a href=http://www.cs.cf.ac.uk/Dave/C/node13.html>graphical explanation</a> for understanding this.<p>See this sample<p><code lang=c>/* libsample.h */<p>typedef struct {<br>unsigned int Some : 1;<br>unsigned int Bit : 2;<br>unsigned int Fields : 5;<br>} MyStruct;<p>MyStruct get_mystruct (void);<p>int some (void);</code><p><code lang=c>/* libsample.c */<br>#include <stdio .h><br>#include "libsample.h"<p>MyStruct get_mystruct (void)<br>{<br>MyStruct a;<br>a.Some = 0x01; //One bit: 1 - 0<br>a.Bit = 0x02; //Two bits: 10 - 2<br>a.Fields = 0x1A; //Five bits: 0001 1010 - 26<br>//Full return: 1101 1010<br>return a;<br>}<p>int some (void)<br>{<br>return 0;<br>}</stdio></code><p>Then compiling<p><code lang=sh><br>gcc -fPIC -Wall -g -c libsample.c<br>gcc -g -shared -Wl,-soname,libsample.so.0 \<br>-o libsample.so.0.0 libsample.o -lc<br>/sbin/ldconfig -n .<br>ln -sf libsample.so.0 libsample.so<br></code><p>Will create the shared libraries, let's see the C# PInvoke.<p><code lang=csharp>using System;<br>using System.Collections;<br>using System.Runtime.InteropServices;<p>public class Sample<br>{<br>[StructLayout (LayoutKind.Sequential, Size=1, Pack=4)]<br>public struct MyStruct<br>{<br>public byte Value;<p>public uint GetSome ()<br>{<br>BitArray bArray = new BitArray (new byte[] { Value });<br>BitFieldFormater a = new BitFieldFormater (bArray);<br>return a.GetInt (0, 1);<br>}<p>public uint GetBit ()<br>{<br>BitArray bArray = new BitArray (new byte[] { Value });<br>BitFieldFormater a = new BitFieldFormater (bArray);<br>return a.GetInt (1, 2);<br>}<p>public uint GetFields ()<br>{<br>BitArray bArray = new BitArray (new byte[] { Value });<br>BitFieldFormater a = new BitFieldFormater (bArray);<br>return a.GetInt (3, 5);<br>}<p>public override string ToString ()<br>{<br>return "Some "+GetSome ()+" Bit "+GetBit ()+" Fields "+GetFields ();<br>}<br>}<p>[DllImport ("libsample.so")]<br>public static unsafe extern MyStruct get_mystruct (); //notice the return value<p>[DllImport ("libsample.so")]<br>public static unsafe extern int some (); //notice the return value<p>public static void Main ()<br>{<br>MyStruct myStruct = get_mystruct ();<br>System.Console.WriteLine ("some (): "+some ());<br>System.Console.WriteLine ("get_mystruct (): "+myStruct);<br>}<br>}</code><p>I'm using thre a class called <strong>BitFieldFormater</strong> for doing the magic:<p><code lang=csharp>using System;<br>using System.Collections;<p>public class BitFieldFormater<br>{<br>public BitFieldFormater (BitArray bitArray)<br>{<br>_bitArray = bitArray;<br>}<p>public uint GetUInt (int beginBit, int bitLength)<br>{<br>if ((beginBit + bitLength) > _bitArray.Count)<br>throw new ArgumentException ("Begin bit plus bit length is greater than array's length");<p>string requestedString = "";<p>//Getting bit values from the BitArray<br>for (int i = 0; i < bitLength; i++)<br>requestedString = Convert.ToInt32 (_bitArray [beginBit + i]) + requestedString;<p>return (uint) BinaryToInteger (requestedString);<br>}<p>private int BinaryToInteger (string binary)<br>{<br>char []elements = binary.ToCharArray ();<br>int result = 0, i = 0, pow = 0;<br>for (i = elements.Length - 1; i >= 0; i--) {<br>if (elements[i] == '1')<br>result += (int) Math.Pow (2, pow);<br>pow++;<br>}<br>return result;<br>}<p>private BitArray _bitArray;<br>}</code><p>Any bugs, please, let me know. I haven't yet tested this class with structs with byte-size greater than 1... further testing is required.<p><strong>UPDATED. Feb 3rd.</strong> Lot of useless code removed... <em>what the fuck was I thinking!?</em></div></div></div></section>