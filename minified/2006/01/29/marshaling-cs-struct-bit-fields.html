<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - Marshaling: C&#39;s struct&#39;s bit fields</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2006/01/29/marshaling-cs-struct-bit-fields.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2006>All posts in 2006</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>Jan 29, 2006
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>Marshaling: C&#39;s struct&#39;s bit fields</h1><div id=post><p>If you are C programmer you might have noticed the existence of the <em>bit fields</em> in structs:<p><code lang=c>typedef struct {<br>int Some : 1;<br>int Bit : 2;<br>int Fields : 5;<br>} MyStruct;</code><p>Marshaling that code could be a pain in the ass. Before all, read <a href=http://www.jprl.com/interop.html>Jonathan's doc</a>, then forget about the C's sizeof, sum all the bit fields and get the value, in our sample struct we need to get that as 1 byte (<em>1 + 2 + 5 = 8 bits = 1 byte</em>) and then use the <strong>System.Collections.BitArray</strong> class, and convert that to their data type value. (I wrote a wrapper for doing this in a easiest way)<p>See the <a href=http://www.cs.cf.ac.uk/Dave/C/node13.html>graphical explanation</a> for understanding this.<p>See this sample<p><code lang=c>/* libsample.h */<p>typedef struct {<br>unsigned int Some : 1;<br>unsigned int Bit : 2;<br>unsigned int Fields : 5;<br>} MyStruct;<p>MyStruct get_mystruct (void);<p>int some (void);</code><p><code lang=c>/* libsample.c */<br>#include <stdio .h><br>#include "libsample.h"<p>MyStruct get_mystruct (void)<br>{<br>MyStruct a;<br>a.Some = 0x01; //One bit: 1 - 0<br>a.Bit = 0x02; //Two bits: 10 - 2<br>a.Fields = 0x1A; //Five bits: 0001 1010 - 26<br>//Full return: 1101 1010<br>return a;<br>}<p>int some (void)<br>{<br>return 0;<br>}</stdio></code><p>Then compiling<p><code lang=sh><br>gcc -fPIC -Wall -g -c libsample.c<br>gcc -g -shared -Wl,-soname,libsample.so.0 \<br>-o libsample.so.0.0 libsample.o -lc<br>/sbin/ldconfig -n .<br>ln -sf libsample.so.0 libsample.so<br></code><p>Will create the shared libraries, let's see the C# PInvoke.<p><code lang=csharp>using System;<br>using System.Collections;<br>using System.Runtime.InteropServices;<p>public class Sample<br>{<br>[StructLayout (LayoutKind.Sequential, Size=1, Pack=4)]<br>public struct MyStruct<br>{<br>public byte Value;<p>public uint GetSome ()<br>{<br>BitArray bArray = new BitArray (new byte[] { Value });<br>BitFieldFormater a = new BitFieldFormater (bArray);<br>return a.GetInt (0, 1);<br>}<p>public uint GetBit ()<br>{<br>BitArray bArray = new BitArray (new byte[] { Value });<br>BitFieldFormater a = new BitFieldFormater (bArray);<br>return a.GetInt (1, 2);<br>}<p>public uint GetFields ()<br>{<br>BitArray bArray = new BitArray (new byte[] { Value });<br>BitFieldFormater a = new BitFieldFormater (bArray);<br>return a.GetInt (3, 5);<br>}<p>public override string ToString ()<br>{<br>return "Some "+GetSome ()+" Bit "+GetBit ()+" Fields "+GetFields ();<br>}<br>}<p>[DllImport ("libsample.so")]<br>public static unsafe extern MyStruct get_mystruct (); //notice the return value<p>[DllImport ("libsample.so")]<br>public static unsafe extern int some (); //notice the return value<p>public static void Main ()<br>{<br>MyStruct myStruct = get_mystruct ();<br>System.Console.WriteLine ("some (): "+some ());<br>System.Console.WriteLine ("get_mystruct (): "+myStruct);<br>}<br>}</code><p>I'm using thre a class called <strong>BitFieldFormater</strong> for doing the magic:<p><code lang=csharp>using System;<br>using System.Collections;<p>public class BitFieldFormater<br>{<br>public BitFieldFormater (BitArray bitArray)<br>{<br>_bitArray = bitArray;<br>}<p>public uint GetUInt (int beginBit, int bitLength)<br>{<br>if ((beginBit + bitLength) > _bitArray.Count)<br>throw new ArgumentException ("Begin bit plus bit length is greater than array's length");<p>string requestedString = "";<p>//Getting bit values from the BitArray<br>for (int i = 0; i < bitLength; i++)<br>requestedString = Convert.ToInt32 (_bitArray [beginBit + i]) + requestedString;<p>return (uint) BinaryToInteger (requestedString);<br>}<p>private int BinaryToInteger (string binary)<br>{<br>char []elements = binary.ToCharArray ();<br>int result = 0, i = 0, pow = 0;<br>for (i = elements.Length - 1; i >= 0; i--) {<br>if (elements[i] == '1')<br>result += (int) Math.Pow (2, pow);<br>pow++;<br>}<br>return result;<br>}<p>private BitArray _bitArray;<br>}</code><p>Any bugs, please, let me know. I haven't yet tested this class with structs with byte-size greater than 1... further testing is required.<p><strong>UPDATED. Feb 3rd.</strong> Lot of useless code removed... <em>what the fuck was I thinking!?</em></div><div id=related><h3>Posts</h3><ul class=posts><li><a href=/archive.html#2006>All posts this year 2006</a></ul><ul class=posts><li><span>Jan 26, 2006</span> <a href=http://www.mariocarrion.com/2006/01/26/nowadays.html>Nowadays</a><li><span>Jan 31, 2006</span> <a href=http://www.mariocarrion.com/2006/01/31/marshaling-second-part-and-qnx.html>Marshaling, second part, and QNX</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-75640250-1','auto');ga('send','pageview');</script>