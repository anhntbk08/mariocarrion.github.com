<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content="Mario Carrion"><meta name=description content="What is bypass_rescue?"><meta property=og:title content="Today I learned: Bypass rescue"><meta property=og:description content="What is bypass_rescue?"><meta property=og:type content=article><meta property=og:url content=https://www.mariocarrion.com/2017/03/29/til-bypass-rescue.html><meta property=article:published_time content=2017-03-29T00:00:00&#43;00:00><meta property=article:modified_time content=2017-03-29T00:00:00&#43;00:00><title>Today I learned: Bypass rescue</title><link rel=canonical href=https://www.mariocarrion.com/2017/03/29/til-bypass-rescue.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Today I learned: Bypass rescue</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Wed Mar 29 2017 00:00:00 UTC">Mar 29, 2017</div></div></div><div class=markdown><p>One of my job goals this sprint is to implement a new controller that internally uses our proprietary ACL and it is available <strong>only</strong> for what we call the <em>Super Admin Role</em>. Obviously this new code will have to be backed up by its own specs where we will be covering the two possible cases:<ol><li>When a valid user has enough permissions (super admin) to access the action, and<li>When a valid user does not have enough permissions to access the action.</ol><p>Depending on what you use for authentication you will do different things to <em>log in</em> your user, but what is important is the actual section in the spec that tests both cases defined above.<p>The easiest one to implement is obviously the case where the user is super admin, assuming we were testing the <code>show</code> method in the controller it would look something like this:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>describe</span> <span style=color:#e6db74>&#39;GET show&#39;</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>let(</span><span style=color:#e6db74>:user</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>create(</span><span style=color:#e6db74>:user</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:super_admin</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>}</span>

  <span style=color:#f8f8f2>it</span> <span style=color:#e6db74>&#39;has access&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#f8f8f2>get</span> <span style=color:#e6db74>:show</span>
    <span style=color:#f8f8f2>expect(response)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>have_http_status(</span><span style=color:#e6db74>:success</span><span style=color:#f8f8f2>)</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span> <span style=color:#75715e># GET show</span>
</code></pre></div><p>Our internal ACL works similar to <a href=https://github.com/CanCanCommunity/cancancan>cancancan</a> where a <a href=https://github.com/CanCanCommunity/cancancan#3-handle-unauthorized-access>rescue_from</a> is added to the main <code>ApplicationController</code> to render the <em>Access Denied</em> page. Think of the following snippet:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>rescue_from</span> <span style=color:#66d9ef>AccessDenied</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>respond_to</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>format</span><span style=color:#f92672>|</span>
    <span style=color:#f8f8f2>format</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>html</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>render</span> <span style=color:#e6db74>&#39;access_denied&#39;</span> <span style=color:#f8f8f2>}</span>
    <span style=color:#f8f8f2>format</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>js</span>   <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>render</span> <span style=color:#e6db74>&#39;access_denied&#39;</span> <span style=color:#f8f8f2>}</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>The <em>funny</em> thing is that if you only replace the user with one with less permissions and practically copy/paste the spec from above your new test <strong>will still pass</strong> because although the user has no access, the final response still succeeds.<p>Enter <a href=https://www.relishapp.com/rspec/rspec-rails/v/3-5/docs/controller-specs/bypass-rescue>bypass_rescue</a>, now if you rewrite your spec for testing your user permissions like this:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>describe</span> <span style=color:#e6db74>&#39;GET show&#39;</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>before</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>bypass_rescue</span> <span style=color:#f8f8f2>}</span>

  <span style=color:#f8f8f2>let(</span><span style=color:#e6db74>:user</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>create(</span><span style=color:#e6db74>:user</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:guest</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>}</span>

  <span style=color:#f8f8f2>it</span> <span style=color:#e6db74>&#39;has NO access&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#f8f8f2>expect</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>get</span> <span style=color:#e6db74>:show</span> <span style=color:#f8f8f2>}</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>raise_error(</span><span style=color:#66d9ef>AccessDenied</span><span style=color:#f8f8f2>)</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span> <span style=color:#75715e># GET show</span>
</code></pre></div><p><strong>That</strong> will really confirm your user has no access to the specific action in your controller.<p><img src=https://media.giphy.com/media/83QtfwKWdmSEo/giphy.gif alt="The more you know" title="The more you know"><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>