<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - Ruby Tip: Sharing VCR cassettes in gems</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2017/02/06/sharing-vcr-cassetts-in-gems.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2017>All posts in 2017</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>Feb 06, 2017
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>Ruby Tip: Sharing VCR cassettes in gems</h1><div id=post><p>Last year I posted a tip for <a href=/2016/03/15/mocking-apis.html>Mocking Web APIs</a>, this post is slightly similar: <strong>using cassettes coming from a gem you depend on and at the same time use your own cassettes</strong>.<p>Think of the following:<blockquote><p>You depend on a Web API (implemented in a gem called <code>fancy-web-api</code>), this gem uses internally VCR for testing, nd you use the responses from that API to build concrete objects that only apply to your implementation.</blockquote><p>How can you reuse those cassettes defined in <code>fancy-web-api</code>?<p>Let&rsquo;s think of the perfect world scenario: we control both <code>fancy-web-api</code> and a new application that uses this gem. This is, of course, s the easiest way to explain this solution, however if that&rsquo;s not your case then contribute to the gem you depend on the following solution.<h3 id=exposing-the-cassettes-from-fancy-web-api>Exposing the cassettes from fancy-web-api</h3><p>The key to reuse the cassettes, or actually any other thing being used for testing (like factories or fixtures), is to expose them so then can be loaded from <em>the outside</em>. In the case of cassettes you would a file included in your <code>fancy-web-api</code> something similar to this:<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#75715e># frozen_string_literal: true</span>

<span style=color:#75715e># Takeaways</span>
<span style=color:#75715e># * This file lives in *your gem* in &quot;web_api/vcr_testing.rb&quot;</span>
<span style=color:#75715e># * VCR cassettes are defined in &quot;../../../spec/cassettes&quot; relative to this file</span>
<span style=color:#66d9ef>module</span> <span style=color:#f8f8f2>FancyWebAPI</span>
  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VCRTesting</span>
    <span style=color:#66d9ef>CASSETTES_PATH</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>expand_path(</span><span style=color:#e6db74>&#39;../../..&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#f8f8f2>__FILE__)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>freeze</span>

    <span style=color:#66d9ef>class</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f8f8f2>self</span>
      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>configure!</span><span style=color:#f8f8f2>(config)</span>
        <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure_rspec_metadata!</span>
        <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>cassette_library_dir</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>join(</span><span style=color:#66d9ef>ROOT_PATH</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>&#39;spec&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>&#39;cassettes&#39;</span><span style=color:#f8f8f2>)</span>
        <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>hook_into</span> <span style=color:#e6db74>:webmock</span>
      <span style=color:#66d9ef>end</span>
    <span style=color:#66d9ef>end</span> <span style=color:#75715e># &lt;&lt; self</span>
  <span style=color:#66d9ef>end</span> <span style=color:#75715e># class</span>
<span style=color:#66d9ef>end</span>
</pre></div><p>So, in both your <code>fancy-web-api</code> and your new application, you are requiring your VCR cassettes like this in your <code>spec_helper.rb</code> (or similar):<p><div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#75715e># frozen_string_literal: true</span>
<span style=color:#f8f8f2>require</span> <span style=color:#e6db74>&#39;fancy_web_api/vcr_testing&#39;</span>

<span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
  <span style=color:#66d9ef>FancyWebAPI</span><span style=color:#f92672>::</span><span style=color:#66d9ef>VCRTesting</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure!(config)</span>
<span style=color:#66d9ef>end</span>
</pre></div><h3 id=specs-usage>Specs usage</h3><p>After calling <code>FancyWebAPI::VCRTesting.configure!</code> you should be able to use the cassettes like you would using the <em>normal</em> VCR syntax, so assuming the <code>fancy-web-api</code> defined a cassette called: <code>https_create</code>, this will work:<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#f8f8f2>require</span> <span style=color:#e6db74>&#39;spec_helper&#39;</span>

<span style=color:#f8f8f2>describe</span> <span style=color:#66d9ef>ClassUsingHTTPSCreate</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>type</span><span style=color:#f8f8f2>:</span> <span style=color:#e6db74>:model</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>context</span> <span style=color:#e6db74>&#39;when request is valid&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>vcr</span><span style=color:#f8f8f2>:</span> <span style=color:#f8f8f2>{</span> <span style=color:#e6db74>cassette_name</span><span style=color:#f8f8f2>:</span> <span style=color:#e6db74>&#39;https_create&#39;</span> <span style=color:#f8f8f2>}</span> <span style=color:#66d9ef>do</span>
    <span style=color:#75715e># Stuff happens here...</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</pre></div><h3 id=using-your-own-cassettes-while-using-other-cassettes>Using your own cassettes while using other cassettes</h3><p>Now, the tricky part comes when you&rsquo;re planning to use <strong>both</strong> your own cassettes and the ones defined in <code>fancy-web-api</code>. The answer is simple, <em>juggle</em> <code>cassette_library_dir=</code>. What&rsquo;s the most elegant way to do so?<p>I personally would use <code>RSpec.configure</code> to define what I want to do, for example:<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>use_my_vcr</span>
  <span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
    <span style=color:#75715e># Configure my VCR accordingly</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>use_fancy_web_api_vcr</span>
  <span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
    <span style=color:#66d9ef>FancyWebAPI</span><span style=color:#f92672>::</span><span style=color:#66d9ef>VCRTesting</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure!(config)</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>RSpec</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>before(</span><span style=color:#e6db74>:all</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:use_my_vcr</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>use_my_vcr</span> <span style=color:#f8f8f2>}</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>before(</span><span style=color:#e6db74>:all</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:use_fancy_web_api_vcr</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>use_fancy_web_api_vcr</span> <span style=color:#f8f8f2>}</span>
<span style=color:#66d9ef>end</span>
</pre></div></div><div id=related><h3>Posts</h3><ul class=posts><li><a href=/archive.html#2017>All posts this year 2017</a></ul><ul class=posts><li><span>Feb 01, 2017</span> <a href=http://www.mariocarrion.com/2017/02/01/february-2017-goals.html>Goals: February 2017</a><li><span>Feb 09, 2017</span> <a href=http://www.mariocarrion.com/2017/02/09/knockoutjs-jquery-custom-bindings.html>KnockoutJS/Jquery Tip: Custom Bindings</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-75640250-1','auto');ga('send','pageview');</script>