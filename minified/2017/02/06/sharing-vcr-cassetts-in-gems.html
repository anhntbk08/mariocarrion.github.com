<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Mario Carrion"><meta name=description content="How can you share a cassette defined in a Gem using VCR?"><meta property="og:title" content="Ruby Tip: Sharing VCR cassettes in gems"><meta property="og:description" content="How can you share a cassette defined in a Gem using VCR?"><meta property="og:type" content="article"><meta property="og:url" content="https://www.mariocarrion.com/2017/02/06/sharing-vcr-cassetts-in-gems.html"><meta property="article:published_time" content="2017-02-06T00:00:00+00:00"><meta property="article:modified_time" content="2017-02-06T00:00:00+00:00"><title>Ruby Tip: Sharing VCR cassettes in gems</title><link rel=canonical href=https://www.mariocarrion.com/2017/02/06/sharing-vcr-cassetts-in-gems.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Ruby Tip: Sharing VCR cassettes in gems</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Mon Feb 6 2017 00:00:00 UTC">Feb 06, 2017</div></div></div><div class=markdown><p>Last year I posted a tip for <a href=/2016/03/15/mocking-apis.html>Mocking Web APIs</a>, this post is slightly similar: <strong>using cassettes coming from a gem you depend on and at the same time use your own cassettes</strong>.<p>Think of the following:<blockquote><p>You depend on a Web API (implemented in a gem called <code>fancy-web-api</code>), this gem uses internally VCR for testing, nd you use the responses from that API to build concrete objects that only apply to your implementation.</blockquote><p>How can you reuse those cassettes defined in <code>fancy-web-api</code>?<p>Let&rsquo;s think of the perfect world scenario: we control both <code>fancy-web-api</code> and a new application that uses this gem. This is, of course, s the easiest way to explain this solution, however if that&rsquo;s not your case then contribute to the gem you depend on the following solution.<h3 id=exposing-the-cassettes-from-fancy-web-api>Exposing the cassettes from fancy-web-api</h3><p>The key to reuse the cassettes, or actually any other thing being used for testing (like factories or fixtures), is to expose them so then can be loaded from <em>the outside</em>. In the case of cassettes you would a file included in your <code>fancy-web-api</code> something similar to this:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#75715e># frozen_string_literal: true</span>

<span style=color:#75715e># Takeaways</span>
<span style=color:#75715e># * This file lives in *your gem* in &quot;web_api/vcr_testing.rb&quot;</span>
<span style=color:#75715e># * VCR cassettes are defined in &quot;../../../spec/cassettes&quot; relative to this file</span>
<span style=color:#66d9ef>module</span> <span style=color:#f8f8f2>FancyWebAPI</span>
  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VCRTesting</span>
    <span style=color:#66d9ef>CASSETTES_PATH</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>expand_path(</span><span style=color:#e6db74>&#39;../../..&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#f8f8f2>__FILE__)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>freeze</span>

    <span style=color:#66d9ef>class</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f8f8f2>self</span>
      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>configure!</span><span style=color:#f8f8f2>(config)</span>
        <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure_rspec_metadata!</span>
        <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>cassette_library_dir</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>join(</span><span style=color:#66d9ef>ROOT_PATH</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>&#39;spec&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>&#39;cassettes&#39;</span><span style=color:#f8f8f2>)</span>
        <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>hook_into</span> <span style=color:#e6db74>:webmock</span>
      <span style=color:#66d9ef>end</span>
    <span style=color:#66d9ef>end</span> <span style=color:#75715e># &lt;&lt; self</span>
  <span style=color:#66d9ef>end</span> <span style=color:#75715e># class</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>So, in both your <code>fancy-web-api</code> and your new application, you are requiring your VCR cassettes like this in your <code>spec_helper.rb</code> (or similar):<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#75715e># frozen_string_literal: true</span>
<span style=color:#f8f8f2>require</span> <span style=color:#e6db74>&#39;fancy_web_api/vcr_testing&#39;</span>

<span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
  <span style=color:#66d9ef>FancyWebAPI</span><span style=color:#f92672>::</span><span style=color:#66d9ef>VCRTesting</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure!(config)</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><h3 id=specs-usage>Specs usage</h3><p>After calling <code>FancyWebAPI::VCRTesting.configure!</code> you should be able to use the cassettes like you would using the <em>normal</em> VCR syntax, so assuming the <code>fancy-web-api</code> defined a cassette called: <code>https_create</code>, this will work:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>require</span> <span style=color:#e6db74>&#39;spec_helper&#39;</span>

<span style=color:#f8f8f2>describe</span> <span style=color:#66d9ef>ClassUsingHTTPSCreate</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>type</span><span style=color:#f8f8f2>:</span> <span style=color:#e6db74>:model</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>context</span> <span style=color:#e6db74>&#39;when request is valid&#39;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>vcr</span><span style=color:#f8f8f2>:</span> <span style=color:#f8f8f2>{</span> <span style=color:#e6db74>cassette_name</span><span style=color:#f8f8f2>:</span> <span style=color:#e6db74>&#39;https_create&#39;</span> <span style=color:#f8f8f2>}</span> <span style=color:#66d9ef>do</span>
    <span style=color:#75715e># Stuff happens here...</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><h3 id=using-your-own-cassettes-while-using-other-cassettes>Using your own cassettes while using other cassettes</h3><p>Now, the tricky part comes when you&rsquo;re planning to use <strong>both</strong> your own cassettes and the ones defined in <code>fancy-web-api</code>. The answer is simple, <em>juggle</em> <code>cassette_library_dir=</code>. What&rsquo;s the most elegant way to do so?<p>I personally would use <code>RSpec.configure</code> to define what I want to do, for example:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>use_my_vcr</span>
  <span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
    <span style=color:#75715e># Configure my VCR accordingly</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>use_fancy_web_api_vcr</span>
  <span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
    <span style=color:#66d9ef>FancyWebAPI</span><span style=color:#f92672>::</span><span style=color:#66d9ef>VCRTesting</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure!(config)</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>RSpec</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>configure</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>before(</span><span style=color:#e6db74>:all</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:use_my_vcr</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>use_my_vcr</span> <span style=color:#f8f8f2>}</span>
  <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>before(</span><span style=color:#e6db74>:all</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:use_fancy_web_api_vcr</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>use_fancy_web_api_vcr</span> <span style=color:#f8f8f2>}</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>