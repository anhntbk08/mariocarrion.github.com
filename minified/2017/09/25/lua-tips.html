<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Mario Carrion"><meta name=description content="LUA and Redis"><meta property="og:title" content="LUA Tips"><meta property="og:description" content="LUA and Redis"><meta property="og:type" content="article"><meta property="og:url" content="https://www.mariocarrion.com/2017/09/25/lua-tips.html"><meta property="article:published_time" content="2017-09-25T00:00:00+00:00"><meta property="article:modified_time" content="2017-09-25T00:00:00+00:00"><title>LUA Tips</title><link rel=canonical href=https://www.mariocarrion.com/2017/09/25/lua-tips.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>LUA Tips</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Mon Sep 25 2017 00:00:00 UTC">Sep 25, 2017</div></div></div><div class=markdown><p>Back in 2014 I faced an interesting challenge regarding the way we where handling millions of concurrent events. Those events are aggregated in real-time to, then, be used in a following process that in the end it&rsquo;s used for our final decisioning process (that&rsquo;s the TLDR version, more stuff happens).<p>Because we introduced a new product, that behaved differently, all of this was not working the way we expected, not to mention requests were increasing significantly day by day. We were running out of time.<p>Perfect storm to say the least.<p>The <em>funny thing</em> is that I had the solution right in front of my nose: LUA. We had the experience of running Redis in production for a few years already, I knew Redis worked nicely but this was the first time to use the embedded LUA. Long story short: it was a great decision.<p>It&rsquo;s going to be 3 years this December and the honeymoon is not over year, as a matter of fact I recently replaced some sections of our decisioning code with LUA and Redis. The results were phenomenal: latency went down (like 50%), overall resources usage went down (EC2 Instances and network internal traffic), throughput duplicated and our Apdex went from 0.5 to .95.<p>Cool beans.<h1 id=development>Development</h1><p>Developing in LUA it&rsquo;s not complex, the language is simple and the documentation is easy to follow. Important things to remember are:<ul><li>There&rsquo;s only one data structure: <strong>table</strong>, but you can implement all others (maps, queues, arrays, etcetera) easily using that one.<li>Indexes start at 1: <code>_yes[1]_</code><li>Beware of Redis+LUA versioning, specially if you use msgpack to communicate with Ruby (or any other language), there are few bugs that depend on your Redis version: <a href=https://github.com/antirez/lua-cmsgpack/pull/44>Support str8</a> and <a href=https://github.com/antirez/lua-cmsgpack/issues/51>@user_script:6 Bad data format in input</a>.</ul><p>Regarding tools, everything is available for Mac (via Homebrew), in the end everything has to be installed using <a href=https://luarocks.org/>luarocks</a> and this seems to be the case for Linux as well.<p>For testing (<a href=https://olivinelabs.com/busted/>busted</a>) and code coverage (<a href=https://keplerproject.github.io/luacov/>luacov</a>) are the way to go. The trick for making sure your LUA code works correctly is to write your tests in LUA (obviously) and then mimic the internal Redis calls through a function, basically using as template the <a href=https://gist.github.com/suprememoocow/4e36e6f29ee07160d42c>work done</a> by <a href=http://blog.gitter.im/2015/01/13/testing-redis-lua-scripts/>Andrew Newdigate</a>.<p>Word of advice: not all Redis commands are available in that harness <a href=https://gist.github.com/suprememoocow/4e36e6f29ee07160d42c#file-harness-lua-L19>LUA function</a> so if you happen to need to access to a new command, like <a href=https://redis.io/commands/exists>exists</a>, you will need to write a tiny wrapper around, it shouldn&rsquo;t be that difficult.</p><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=UA-75640250-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-75640250-1');</script>