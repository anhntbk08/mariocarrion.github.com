<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - LUA Tips</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2017/09/25/lua-tips.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2017>All posts in 2017</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>Sep 25, 2017
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>LUA Tips</h1><div id=post><p>Back in 2014 I faced an interesting challenge regarding the way we where handling millions of concurrent events. Those events are aggregated in real-time to, then, be used in a following process that in the end it&rsquo;s used for our final decisioning process (that&rsquo;s the TLDR version, more stuff happens).<p>Because we introduced a new product, that behaved differently, all of this was not working the way we expected, not to mention requests were increasing significantly day by day. We were running out of time.<p>Perfect storm to say the least.<p>The <em>funny thing</em> is that I had the solution right in front of my nose: LUA. We had the experience of running Redis in production for a few years already, I knew Redis worked nicely but this was the first time to use the embedded LUA. Long story short: it was a great decision.<p>It&rsquo;s going to be 3 years this December and the honeymoon is not over year, as a matter of fact I recently replaced some sections of our decisioning code with LUA and Redis. The results were phenomenal: latency went down (like 50%), overall resources usage went down (EC2 Instances and network internal traffic), throughput duplicated and our Apdex went from 0.5 to .95.<p>Cool beans.<h1 id=development>Development</h1><p>Developing in LUA it&rsquo;s not complex, the language is simple and the documentation is easy to follow. Important things to remember are:<ul><li>There&rsquo;s only one data structure: <strong>table</strong>, but you can implement all others (maps, queues, arrays, etcetera) easily using that one.<li>Indexes start at 1: <code>_yes[1]_</code><li>Beware of Redis+LUA versioning, specially if you use msgpack to communicate with Ruby (or any other language), there are few bugs that depend on your Redis version: <a href=https://github.com/antirez/lua-cmsgpack/pull/44>Support str8</a> and <a href=https://github.com/antirez/lua-cmsgpack/issues/51>@user_script:6 Bad data format in input</a>.</ul><p>Regarding tools, everything is available for Mac (via Homebrew), in the end everything has to be installed using <a href=https://luarocks.org/>luarocks</a> and this seems to be the case for Linux as well.<p>For testing (<a href=https://olivinelabs.com/busted/>busted</a>) and code coverage (<a href=https://keplerproject.github.io/luacov/>luacov</a>) are the way to go. The trick for making sure your LUA code works correctly is to write your tests in LUA (obviously) and then mimic the internal Redis calls through a function, basically using as template the <a href=https://gist.github.com/suprememoocow/4e36e6f29ee07160d42c>work done</a> by <a href=http://blog.gitter.im/2015/01/13/testing-redis-lua-scripts/>Andrew Newdigate</a>.<p>Word of advice: not all Redis commands are available in that harness <a href=https://gist.github.com/suprememoocow/4e36e6f29ee07160d42c#file-harness-lua-L19>LUA function</a> so if you happen to need to access to a new command, like <a href=https://redis.io/commands/exists>exists</a>, you will need to write a tiny wrapper around, it shouldn&rsquo;t be that difficult.</div><div id=related><h3>Posts</h3><ul class=posts><li><a href=/archive.html#2017>All posts this year 2017</a></ul><ul class=posts><li><span>Sep 15, 2017</span> <a href=http://www.mariocarrion.com/2017/09/15/the-healthy-programmer.html>Finished Reading: The Healthy Programmer</a><li><span>Oct 01, 2017</span> <a href=http://www.mariocarrion.com/2017/10/01/october-2017-goals.html>Goals: October 2017</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-75640250-1','auto');ga('send','pageview');</script>