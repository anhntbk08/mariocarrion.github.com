<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Mario Carrion"><meta name=description content="ActiveModel::Dirty is a phenomenal way to detect the changes in a model,"><meta property="og:title" content="Tip: Dirty Associations with Active Record"><meta property="og:description" content="ActiveModel::Dirty is a phenomenal way to detect the changes in a model,"><meta property="og:type" content="article"><meta property="og:url" content="https://www.mariocarrion.com/2015/07/01/dirty-associations.html"><meta property="article:published_time" content="2015-07-01T00:00:00+00:00"><meta property="article:modified_time" content="2015-07-01T00:00:00+00:00"><title>Tip: Dirty Associations with Active Record</title><link rel=canonical href=https://www.mariocarrion.com/2015/07/01/dirty-associations.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Tip: Dirty Associations with Active Record</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Wed Jul 1 2015 00:00:00 UTC">Jul 01, 2015</div></div></div><div class=markdown><p>Depending on your project you may need to know exactly when something changes in your model, to do whatever you have to do, specially important if you need to know what changed <strong>inside</strong> the associations defined in your model.<p>So, how do we know, when modifying a model, what <em>changed</em> inside that model?<p>The simplest answer would be: <a href=http://api.rubyonrails.org/classes/ActiveModel/Dirty.html>ActiveModel::Dirty</a>, and that works, except it does not consider associations (which is the whole point of this post); so how do we get what changed inside the associations?!<p>First a little context, in Ruby on Rails I use <a href=https://blog.engineyard.com/2014/keeping-your-rails-controllers-dry-with-services>Services</a> and <a href=https://github.com/krisleech/wisper>Wisper</a> to keep my models slim and the external logic <em>outside</em> the model, which although related to the business, is not relevant to the actual models themselves.<p>That being said, let&rsquo;s assume I have a model and according my to business rules, I have to create/update a file after this model is updated. How can we do this? Hint: <strong>not using callbacks</strong>, like <code>after_save</code>, that for sure!<p>Again, let&rsquo;s assume I have my controller that uses a service to update the model, inside this service I use Wispper to broadcast the changes after saving a <code>valid?</code> record. Everything fine and dandy so far.<p>But&hellip; how do I determine what changed inside the associations? How do I know in the service, what to broadcast if one of items in a particular association changed? Because for whatever reason, this model does some crazy stuff regarding a particular association, and honestly I <strong>only</strong> want to make those changes when that association or any item from that association changes.<p>Well, here&rsquo;s my solution, a little bit of reflection and <a href=http://api.rubyonrails.org/classes/ActiveSupport/Concern.html>concerns</a>.<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#66d9ef>module</span> <span style=color:#f8f8f2>Dirtyable</span>
  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>ActiveSupport</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Concern</span>

  <span style=color:#66d9ef>WhatChanged</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Struct</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new(</span><span style=color:#e6db74>:object</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>:changes</span><span style=color:#f8f8f2>)</span> <span style=color:#66d9ef>do</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>changed?</span>
      <span style=color:#f8f8f2>self</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>NoChanges</span>
    <span style=color:#66d9ef>end</span>
    <span style=color:#f8f8f2>delegate</span> <span style=color:#e6db74>:has_key?</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>to</span><span style=color:#f8f8f2>:</span> <span style=color:#e6db74>:changes</span>
  <span style=color:#66d9ef>end</span>
  <span style=color:#66d9ef>NoChanges</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>WhatChanged</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new(</span><span style=color:#66d9ef>nil</span><span style=color:#f8f8f2>,</span> <span style=color:#66d9ef>nil</span><span style=color:#f8f8f2>)</span>

  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>what_changed?</span>
    <span style=color:#f8f8f2>what_changed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>nil</span>

    <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>previous_changes</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>delete(</span><span style=color:#e6db74>&#39;updated_at&#39;</span><span style=color:#f8f8f2>)</span>
    <span style=color:#66d9ef>unless</span> <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>previous_changes</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>empty?</span>
      <span style=color:#f8f8f2>what_changed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>WhatChanged</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new(self,</span> <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>previous_changes)</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#f8f8f2>associations</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>class</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>reflections</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>select</span> <span style=color:#f8f8f2>{</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>k,</span> <span style=color:#f8f8f2>v</span><span style=color:#f92672>|</span> <span style=color:#f8f8f2>v</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>collection?</span> <span style=color:#f8f8f2>}</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>keys</span>

    <span style=color:#f8f8f2>associations</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>each</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>association_name</span><span style=color:#f92672>|</span>
      <span style=color:#66d9ef>catch</span> <span style=color:#e6db74>:next_association_name</span> <span style=color:#66d9ef>do</span>
        <span style=color:#f8f8f2>association_collection</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>send(association_name)</span>
        <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>:next_association_name</span> <span style=color:#66d9ef>unless</span> <span style=color:#f8f8f2>association_collection</span>
        <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>:next_association_name</span> <span style=color:#66d9ef>if</span> <span style=color:#f8f8f2>association_collection</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>empty?</span>

        <span style=color:#f8f8f2>association_collection</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>each</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>item</span><span style=color:#f92672>|</span>
          <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>:next_association_name</span> <span style=color:#66d9ef>unless</span> <span style=color:#f8f8f2>item</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>respond_to?(</span><span style=color:#e6db74>:what_changed?</span><span style=color:#f8f8f2>)</span>

          <span style=color:#f8f8f2>association_changes</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>item</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>what_changed?</span>
          <span style=color:#66d9ef>if</span> <span style=color:#f8f8f2>association_changes</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>NoChanges</span>
            <span style=color:#f8f8f2>what_changed</span> <span style=color:#f92672>||=</span> <span style=color:#66d9ef>WhatChanged</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new(self,</span> <span style=color:#f8f8f2>{})</span>

            <span style=color:#f8f8f2>what_changed</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>changes</span><span style=color:#f92672>[</span><span style=color:#f8f8f2>association_name</span><span style=color:#f92672>]</span> <span style=color:#f92672>||=</span> <span style=color:#f92672>[]</span>
            <span style=color:#f8f8f2>what_changed</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>changes</span><span style=color:#f92672>[</span><span style=color:#f8f8f2>association_name</span><span style=color:#f92672>]</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f8f8f2>association_changes</span>
          <span style=color:#66d9ef>end</span>
        <span style=color:#66d9ef>end</span>
      <span style=color:#66d9ef>end</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#f8f8f2>what_changed</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>NoChanges</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>The module above is pretty straightforward, it uses both <code>ActiveModel::Dirty</code> and reflection to get the associations that have changes, however the important thing is that in order to make this work all models that you want to keep track of must include this module.<p>So for example if you have a couple of models like this:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FancyModel</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>Dirtyable</span>
  
  <span style=color:#f8f8f2>has_many</span> <span style=color:#e6db74>:things</span>
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Thing</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>Dirtyable</span>
  
  <span style=color:#f8f8f2>belongs_to</span> <span style=color:#e6db74>:fancy_model</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>You can easily get the changes when updating FancyModel (and having changes in any of the <code>things</code>, in your service for example), of what changed by just executing a call like this:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>what_changed</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>fancy_model</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>what_changed?</span>
<span style=color:#66d9ef>if</span> <span style=color:#f8f8f2>what_changed</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>changed?</span>
  <span style=color:#66d9ef>if</span> <span style=color:#f8f8f2>what_changed</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>has_key?(</span><span style=color:#e6db74>:things</span><span style=color:#f8f8f2>)</span>
    <span style=color:#75715e># I do whatever I have to do... maybe call &quot;broadcast(:on_things_changed)&quot;?</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Pretty cool. With that you can easily broadcast specific events when specific things change, no need to broadcast a global <em>on_model_changed</em> if you don&rsquo;t have to.</p><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=UA-75640250-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-75640250-1');</script>