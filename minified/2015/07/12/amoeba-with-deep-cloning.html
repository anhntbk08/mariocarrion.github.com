<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - Tip: Amoeba with deep cloning</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2015/07/12/amoeba-with-deep-cloning.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2015>All posts in 2015</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>Jul 12, 2015
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>Tip: Amoeba with deep cloning</h1><div id=post><p>One of the basic things <a href=http://www.selectablemedia.com>we</a> always do is duplication, and since we use Rails (and therefore ActiveRecord) duplicating objects clearly is a must. I recall I was in charge of implementing duplication and back at that time I decided to use reflection to duplicate the elements and although it worked, it grew out of control.<p>In next big iteration of the project, one of our engineers decided to use <a href=https://github.com/moiristo/deep_cloneable>deep_cloneable</a>. Which worked really good in the beginning, until our models started to become more complex and the need of including their associations (and their associations&rsquo; associations) was a requirement. Adding those associations became extremely painful and specially confusing.<p>Finally after more research another of our engineers suggested a new gem called <a href=https://github.com/amoeba-rb/amoeba>amoeba</a>, which worked really well because defining what to clone and how to clone it was clear. However there was a caveat: inheritance, specially <a href=http://api.rubyonrails.org/classes/ActiveRecord/Base.html#class-ActiveRecord::Base-label-Single+table+inheritance>Single Table Inheritance</a>.<p>According to the <a href=https://github.com/amoeba-rb/amoeba/blob/master/README.md>README</a>, STI is supported&hellip; sort of, the truth is after testing the different options and reading the source code it became obvious that inheritance wasn&rsquo;t properly supported, and we needed it.<p>So, after thinking a little bit I decided to write a little <a href=http://api.rubyonrails.org/classes/ActiveSupport/Concern.html>concern</a> to handle this in a <em>better way</em>. The goals of this concern where specifically:<ol><li>To define the <code>duplicate</code> method<li>To define a block that uses amoeba&rsquo;s DSL<li>Allow inherited blocks to be properly inherited by subclasses<li>Profit</ol><p>The solution was the following:<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#75715e># If you use amoeba (https://github.com/amoeba-rb/amoeba) for cloning your</span>
<span style=color:#75715e># ActiveRecord objects this concern should be useful, it allows you properfly inherit</span>
<span style=color:#75715e># associations if you use (Single Table) Inheritance.</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># Just do something like:</span>
<span style=color:#75715e># </span>
<span style=color:#75715e># class SomeTable &lt; ActiveRecord::Base</span>
<span style=color:#75715e>#   has_many :somethings</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e>#   duplicate_this do</span>
<span style=color:#75715e>#     include_association :somethings</span>
<span style=color:#75715e>#   end</span>
<span style=color:#75715e># end</span>

<span style=color:#66d9ef>module</span> <span style=color:#f8f8f2>Duplicable</span>
  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>ActiveSupport</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Concern</span>

  <span style=color:#f8f8f2>included</span> <span style=color:#66d9ef>do</span>
    <span style=color:#f8f8f2>class_attribute</span> <span style=color:#e6db74>:amoeba_blocks</span>
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>module</span> <span style=color:#f8f8f2>ClassMethods</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>inherited</span><span style=color:#f8f8f2>(subclass)</span>
      <span style=color:#66d9ef>super</span>
      <span style=color:#f8f8f2>subclass</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>duplicate_this</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>duplicate_this</span><span style=color:#f8f8f2>(</span><span style=color:#f92672>&amp;</span><span style=color:#f8f8f2>block)</span>
      <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>amoeba_blocks</span> <span style=color:#f92672>||=</span> <span style=color:#66d9ef>begin</span>
        <span style=color:#f8f8f2>blocks</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#66d9ef>Proc</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new</span> <span style=color:#f8f8f2>{</span> <span style=color:#f8f8f2>enable</span> <span style=color:#f8f8f2>}</span> <span style=color:#f92672>]</span>

        <span style=color:#f8f8f2>superclass</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>nil</span>
        <span style=color:#66d9ef>loop</span> <span style=color:#66d9ef>do</span>
          <span style=color:#f8f8f2>superclass</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>superclass</span>
          <span style=color:#66d9ef>break</span> <span style=color:#66d9ef>if</span> <span style=color:#f8f8f2>superclass</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>

          <span style=color:#f8f8f2>blocks</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>unshift(</span><span style=color:#f92672>*</span><span style=color:#f8f8f2>superclass</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>amoeba_blocks)</span>
        <span style=color:#66d9ef>end</span>

        <span style=color:#f8f8f2>blocks</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f8f8f2>block</span> <span style=color:#66d9ef>if</span> <span style=color:#f8f8f2>block_given?</span>

        <span style=color:#f8f8f2>blocks</span>
      <span style=color:#66d9ef>end</span>

      <span style=color:#f8f8f2>blocks</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>amoeba_blocks</span>

      <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>amoeba</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
        <span style=color:#f8f8f2>blocks</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>each</span> <span style=color:#f8f8f2>{</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>db</span><span style=color:#f92672>|</span> <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>instance_eval(</span><span style=color:#f92672>&amp;</span><span style=color:#f8f8f2>db)</span> <span style=color:#f8f8f2>}</span>
      <span style=color:#66d9ef>end</span>
    <span style=color:#66d9ef>end</span>
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>duplicate</span>
    <span style=color:#f8f8f2>blocks</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>class</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>amoeba_blocks</span> <span style=color:#f92672>||</span> <span style=color:#f92672>[]</span>

    <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>class</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>amoeba</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>config</span><span style=color:#f92672>|</span>
      <span style=color:#f8f8f2>blocks</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>each</span> <span style=color:#f8f8f2>{</span> <span style=color:#f92672>|</span><span style=color:#f8f8f2>db</span><span style=color:#f92672>|</span> <span style=color:#f8f8f2>config</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>instance_eval(</span><span style=color:#f92672>&amp;</span><span style=color:#f8f8f2>db)</span> <span style=color:#f8f8f2>}</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#f8f8f2>self</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>amoeba_dup</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</pre></div><p>What is important to notice in the gist above is two things:<ol><li>The <code>inherited</code> method and<li>The methods <code>duplicate</code> and <code>duplicate_this</code></ol><p>First, the <a href=http://ruby-doc.org/core-2.2.2/Class.html#method-i-inherited>inherited</a> method. This method is callback that is executed immediately whenever a subclass of the current class is created, in other words: if <em>class A</em> includes <em>module Duplicable</em> and then <em>class B</em> subclasses <em>class A</em>, <code>inherited</code> is called. This is specially important in cases where subclasses do not explicitly call the <code>duplicate_this</code> method but still need to support <code>duplicate</code>&hellip; which is the whole point of subclassing a <em>Duplicable</em> class.<p>Second, the methods <code>duplicate</code> and <code>duplicate_this</code>. If you notice the <em>magic</em> behind this concern is basically saving all the blocks (that include amoeba&rsquo;s DSL) in a <a href=http://api.rubyonrails.org/classes/Class.html#method-i-class_attribute>class_attribute</a> called <em>amoeba_blocks</em>, and then invoking them using <code>instance_eval</code>, so in the end amoeba is the one executing all the blocks and therefore properly invoking their methods.<p>Metaprogramming at its finest if you ask me.</div><div id=related><h3>Posts</h3><ul class=posts><li><a href=/archive.html#2015>All posts this year 2015</a></ul><ul class=posts><li><span>Jul 01, 2015</span> <a href=http://www.mariocarrion.com/2015/07/01/dirty-associations.html>Tip: Dirty Associations with Active Record</a><li><span>Jul 16, 2015</span> <a href=http://www.mariocarrion.com/2015/07/16/practical-object-oriented-design-in-ruby.html>Finished Reading: Practical Object-Oriented Design in Ruby</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-75640250-1','auto');ga('send','pageview');</script>