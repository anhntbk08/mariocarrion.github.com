<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content="Mario Carrion"><meta name=description content="Are you wondering how to test that a particular method invokes something"><meta property=og:title content="Tip: RSpec spies"><meta property=og:description content="Are you wondering how to test that a particular method invokes something"><meta property=og:type content=article><meta property=og:url content=https://www.mariocarrion.com/2015/05/12/rspec-spies.html><meta property=article:published_time content=2015-05-12T00:00:00&#43;00:00><meta property=article:modified_time content=2015-05-12T00:00:00&#43;00:00><title>Tip: RSpec spies</title><link rel=canonical href=https://www.mariocarrion.com/2015/05/12/rspec-spies.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Tip: RSpec spies</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Tue May 12 2015 00:00:00 UTC">May 12, 2015</div></div></div><div class=markdown><p><a href=https://relishapp.com/rspec/rspec-mocks/docs/basics/spies>RSpec&rsquo;s spies</a> are a cool thing for testing a message was received after invoking certain method. Like for example to make sure our <a href=https://netguru.co/blog/service-objects-in-rails-will-help>Service</a> that implements <a href=https://github.com/krisleech/wisper>Wisper</a> is always subscribing to certain listener.<p>Also, if you&rsquo;re not familiar with Wisper, make sure to check it out, is a cool way to implement Publish-Subscribe capabilities, really awesome.<p>Anyways, let&rsquo;s assume we want to test the create method in our controller, and its implementation is something like this:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create</span>
  <span style=color:#f8f8f2>service</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>MyCustomService</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new(params)</span>
  <span style=color:#f8f8f2>service</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>subscribe(</span><span style=color:#66d9ef>MySubscriber</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new)</span>
  
  <span style=color:#75715e># I do whatever I have to do in after this</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>In create we want to make sure our service always subscribes to <code>MySubscriber</code>. How do we test this?<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-ruby data-lang=ruby><span></span><span style=color:#f8f8f2>describe</span> <span style=color:#e6db74>&#39;Service is subscribing to&#39;</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>context</span> <span style=color:#e6db74>&#39;MySubscriber&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#f8f8f2>let!(</span><span style=color:#e6db74>:service_double</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span>
      <span style=color:#f8f8f2>service_double</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>double(</span><span style=color:#e6db74>&#39;service&#39;</span><span style=color:#f8f8f2>)</span>
      <span style=color:#f8f8f2>allow(service_double)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>receive(</span><span style=color:#e6db74>:subscribe</span><span style=color:#f8f8f2>)</span>
      <span style=color:#f8f8f2>allow(</span><span style=color:#66d9ef>MyCustomService</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>receive(</span><span style=color:#e6db74>:new</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>and_return(service_double)</span>
      <span style=color:#f8f8f2>service_double</span>
    <span style=color:#f8f8f2>}</span>

    <span style=color:#f8f8f2>let!(</span><span style=color:#e6db74>:subscriber_double</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span>
      <span style=color:#f8f8f2>subscriber_double</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>instance_double(</span><span style=color:#66d9ef>MySubscriber</span><span style=color:#f8f8f2>)</span>
      <span style=color:#f8f8f2>allow(</span><span style=color:#66d9ef>MySubscriber</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>receive(</span><span style=color:#e6db74>:new</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>and_return(subscriber_double)</span>
      <span style=color:#f8f8f2>subscriber_double</span>
    <span style=color:#f8f8f2>}</span>

    <span style=color:#f8f8f2>it</span> <span style=color:#e6db74>&#39;on create&#39;</span> <span style=color:#66d9ef>do</span>
      <span style=color:#f8f8f2>my_model</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>FactoryGirl</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>build(</span><span style=color:#e6db74>:my_model</span><span style=color:#f8f8f2>)</span>

      <span style=color:#f8f8f2>post</span> <span style=color:#e6db74>:create</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>model</span><span style=color:#f8f8f2>:</span> <span style=color:#f8f8f2>my_model</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>attributes</span>

      <span style=color:#f8f8f2>expect(service_double)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>have_received(</span><span style=color:#e6db74>:subscribe</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>with(subscriber_double)</span>
    <span style=color:#66d9ef>end</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>What the above spec means is the following:<ol><li><code>let!(service_double)</code>: We create a <a href=https://www.relishapp.com/rspec/rspec-mocks/docs>double</a> of <code>MyCustomService</code>, we mock <code>subscribe</code> to allow spying on it and we make sure the <code>new</code> method in our service class always returns this double.<li><code>let!(:subscriber_double)</code>: We create in <a href=https://www.relishapp.com/rspec/rspec-mocks/v/3-2/docs/verifying-doubles/using-an-instance-double>instance double</a> and similar to our <code>MyCustomService</code> mocking, we mock <code>MySubscriber#new</code> to return this double. The idea is that we can confirm the subscribe was called with this particular instance.<li>Finally <code>expect(service_double).to have_received(:subscribe).with(subscriber_double)</code>: This is what closes the deal in our test, we are basically saying: <em>my mocked service called subscribe and it actually included my mocked subscriber</em> AKA <strong>my create is subscribing to my listener</strong>.</ol><p>Pretty cool stuff to enforce certain requirements in specific methods.<br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>