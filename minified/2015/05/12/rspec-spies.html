<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mario Carrion - Tip: RSpec spies</title><meta name=author content="Mario Carrion"><meta name=description content="The blog of Mario Carrion"><link rel=canonical href=http://www.mariocarrion.com/2015/05/12/rspec-spies.html><link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/screen.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css><div class=container><div class="four columns sidebar"><nav><h1>Hello stranger!</h1><a href=/><img src=/images/logo.png id=logo alt="Blog logo" class=circular></a><h1>I&#39;m <a href=/about.html>Mario Carrion</a></h1><hr><ul id=blog-pages class=posts><li><span>&raquo; </span><a href=/about.html>About me</a><li><span>&raquo; </span><a href=/books.html>Books</a><li><span>&raquo; </span><a href=/disclaimer.html>Disclaimer</a><li><span>&raquo; </span><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM>Resume</a><li><span>&raquo; </span><a href=/archive.html#2015>All posts in 2015</a></ul><div id=social><div id=stalker><a href=https://github.com/MarioCarrion><i class="fa fa-github-square"></i></a><a href=http://stackoverflow.com/users/134327><i class="fa fa-stack-overflow"></i></a><a href=https://twitter.com/mariocarrion><i class="fa fa-twitter-square"></i></a><a href=https://www.linkedin.com/in/mariocarrion><i class="fa fa-linkedin-square"></i></a></div></div></nav></div><div class="eleven columns content"><p class=meta>May 12, 2015
<a href=/><i class="home fa fa-home"></i></a><h1 class=title>Tip: RSpec spies</h1><div id=post><p><a href=https://relishapp.com/rspec/rspec-mocks/docs/basics/spies>RSpec&rsquo;s spies</a> are a cool thing for testing a message was received after invoking certain method. Like for example to make sure our <a href=https://netguru.co/blog/service-objects-in-rails-will-help>Service</a> that implements <a href=https://github.com/krisleech/wisper>Wisper</a> is always subscribing to certain listener.<p>Also, if you&rsquo;re not familiar with Wisper, make sure to check it out, is a cool way to implement Publish-Subscribe capabilities, really awesome.<p>Anyways, let&rsquo;s assume we want to test the create method in our controller, and its implementation is something like this:<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create</span>
  <span style=color:#f8f8f2>service</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>MyCustomService</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new(params)</span>
  <span style=color:#f8f8f2>service</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>subscribe(</span><span style=color:#66d9ef>MySubscriber</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new)</span>
  
  <span style=color:#75715e># I do whatever I have to do in after this</span>
<span style=color:#66d9ef>end</span>
</pre></div><p>In create we want to make sure our service always subscribes to <code>MySubscriber</code>. How do we test this?<div class=highlight style=background:#272822><pre style=line-height:125%><span></span><span style=color:#f8f8f2>describe</span> <span style=color:#e6db74>&#39;Service is subscribing to&#39;</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f8f8f2>context</span> <span style=color:#e6db74>&#39;MySubscriber&#39;</span> <span style=color:#66d9ef>do</span>
    <span style=color:#f8f8f2>let!(</span><span style=color:#e6db74>:service_double</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span>
      <span style=color:#f8f8f2>service_double</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>double(</span><span style=color:#e6db74>&#39;service&#39;</span><span style=color:#f8f8f2>)</span>
      <span style=color:#f8f8f2>allow(service_double)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>receive(</span><span style=color:#e6db74>:subscribe</span><span style=color:#f8f8f2>)</span>
      <span style=color:#f8f8f2>allow(</span><span style=color:#66d9ef>MyCustomService</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>new)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>receive(</span><span style=color:#e6db74>:new</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>and_return(service_double)</span>
      <span style=color:#f8f8f2>service_double</span>
    <span style=color:#f8f8f2>}</span>

    <span style=color:#f8f8f2>let!(</span><span style=color:#e6db74>:subscriber_double</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span>
      <span style=color:#f8f8f2>subscriber_double</span> <span style=color:#f92672>=</span> <span style=color:#f8f8f2>instance_double(</span><span style=color:#66d9ef>MySubscriber</span><span style=color:#f8f8f2>)</span>
      <span style=color:#f8f8f2>allow(</span><span style=color:#66d9ef>MySubscriber</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>receive(</span><span style=color:#e6db74>:new</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>and_return(subscriber_double)</span>
      <span style=color:#f8f8f2>subscriber_double</span>
    <span style=color:#f8f8f2>}</span>

    <span style=color:#f8f8f2>it</span> <span style=color:#e6db74>&#39;on create&#39;</span> <span style=color:#66d9ef>do</span>
      <span style=color:#f8f8f2>my_model</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>FactoryGirl</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>build(</span><span style=color:#e6db74>:my_model</span><span style=color:#f8f8f2>)</span>

      <span style=color:#f8f8f2>post</span> <span style=color:#e6db74>:create</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>model</span><span style=color:#f8f8f2>:</span> <span style=color:#f8f8f2>my_model</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>attributes</span>

      <span style=color:#f8f8f2>expect(service_double)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>to</span> <span style=color:#f8f8f2>have_received(</span><span style=color:#e6db74>:subscribe</span><span style=color:#f8f8f2>)</span><span style=color:#f92672>.</span><span style=color:#f8f8f2>with(subscriber_double)</span>
    <span style=color:#66d9ef>end</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</pre></div><p>What the above spec means is the following:<ol><li><code>let!(service_double)</code>: We create a <a href=https://www.relishapp.com/rspec/rspec-mocks/docs>double</a> of <code>MyCustomService</code>, we mock <code>subscribe</code> to allow spying on it and we make sure the <code>new</code> method in our service class always returns this double.<li><code>let!(:subscriber_double)</code>: We create in <a href=https://www.relishapp.com/rspec/rspec-mocks/v/3-2/docs/verifying-doubles/using-an-instance-double>instance double</a> and similar to our <code>MyCustomService</code> mocking, we mock <code>MySubscriber#new</code> to return this double. The idea is that we can confirm the subscribe was called with this particular instance.<li>Finally <code>expect(service_double).to have_received(:subscribe).with(subscriber_double)</code>: This is what closes the deal in our test, we are basically saying: <em>my mocked service called subscribe and it actually included my mocked subscriber</em> AKA <strong>my create is subscribing to my listener</strong>.</ol><p>Pretty cool stuff to enforce certain requirements in specific methods.</div><div id=related><h3>Posts</h3><ul class=posts><li><a href=/archive.html#2015>All posts this year 2015</a></ul><ul class=posts><li><span>Feb 12, 2015</span> <a href=http://www.mariocarrion.com/2015/02/12/book-1-soft-skills.html>Finished Reading: Soft Skills</a><li><span>Jun 23, 2015</span> <a href=http://www.mariocarrion.com/2015/06/23/books-mid-year-update.html>Mid 2015 Books Update</a></ul></div><div class=footer><div class=disclaimer><p>The postings on this site are my own and do not represent my
<a href=http://www.meredith.com/>employer's</a> positions, strategies or opinions.<p>&copy; Mario Carrion, 2004-2016 &mdash; built with <a href=https://gohugo.io/>Hugo</a> using a heavily modified version of <a href=https://github.com/swanson/lagom>Lagom theme</a></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-75640250-1','auto');ga('send','pageview');</script>