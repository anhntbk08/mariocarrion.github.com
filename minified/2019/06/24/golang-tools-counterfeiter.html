<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><meta name=author content="Mario Carrion"><meta name=description content="counterfeiter a tool generating type-safe doubles in Go."><meta property=og:title content="Go Tool: counterfeiter"><meta property=og:description content="counterfeiter a tool generating type-safe doubles in Go."><meta property=og:type content=article><meta property=og:url content=https://www.mariocarrion.com/2019/06/24/golang-tools-counterfeiter.html><meta property=article:published_time content=2019-06-24T00:00:00&#43;00:00><meta property=article:modified_time content=2019-06-24T00:00:00&#43;00:00><title>Go Tool: counterfeiter</title><link rel=canonical href=https://www.mariocarrion.com/2019/06/24/golang-tools-counterfeiter.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Go Tool: counterfeiter</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Mon Jun 24 2019 00:00:00 UTC">Jun 24, 2019</div></div></div><div class=markdown><p><a href=https://github.com/maxbrunsfeld/counterfeiter><strong>counterfeiter</strong></a> has been one of those tools we can not live without when building software in Go, specially because we build our enterprise systems using <a href=/2018/11/07/domain-driven-design-go-loteria.html>Domain Driven Design</a> and we heavily use Dependency Injection to properly separate and test layers independently.<p>I briefly mentioned <code>counterfeiter</code> in <a href=/2019/04/17/golang-tools-twitchtv-retool.html>my previous <em>Go Tool</em> post</a>, this time I will dive a bit deeper.<p><code>counterfeiter</code> is useful when using <a href=https://blog.golang.org/generate><code>generate</code></a> directives in your code to automatically generate Fakes/Doubles/Mocks from dependent interfaces you define in your code.<p>For example, assuming you have the following code:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Writer</span> <span style=color:#66d9ef>interface</span> <span style=color:#f8f8f2>{</span>
  <span style=color:#a6e22e>Write</span><span style=color:#f8f8f2>()</span> <span style=color:#66d9ef>error</span>
<span style=color:#f8f8f2>}</span>
</code></pre></div><p>And you have a piece of code like:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WriteSomething</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>w</span> <span style=color:#a6e22e>Writer</span><span style=color:#f8f8f2>)</span> <span style=color:#66d9ef>bool</span> <span style=color:#f8f8f2>{</span>
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Write</span><span style=color:#f8f8f2>();</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f8f8f2>{</span>
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
  <span style=color:#f8f8f2>}</span>
  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
<span style=color:#f8f8f2>}</span>
</code></pre></div><p>Adding the following directive:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#75715e>//go:generate counterfeiter -o fake/writer.gen.go -fake-name Writer . Writer</span>
</code></pre></div><p><code>counterfeiter</code> will generate a new type <code>fake.Writer</code> that will allow you to use those instances as <em>dummies</em>, as well as giving you full control to <em>fake</em>, <em>stub</em>, <em>mock</em> and <em>spy</em> that said instance.<p>Using this simple method in this interface, the generated methods include:<ul><li><code>Write() error</code>: to satisfy the interface,<li><code>WriteCallCount() int</code>: to determine how many times the method was called,<li><code>WriteCalls(func() error)</code>: to define a method that returns the same as the original interface, equal to <code>w.WriteStub</code> but goroutine-safe,<li><code>WriteReturns(error)</code>: to return the value all the times <code>Write</code> is called, and<li><code>WriteReturnsOnCall(int, error)</code>: to return specific values for specific calls at specific times.</ul><p>With those autogenerated methods you have more than enough to <a href=https://gitlab.com/MarioCarrion/blog-examples/tree/master/2019/06/24>properly test your external dependencies</a> and how they affect your internal flow.<p><code>counterfeiter</code> is a really powerful tool. Highly recommended.<hr><p><img src=https://media.giphy.com/media/83QtfwKWdmSEo/giphy.gif alt="The more you know" title="The more you know"><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>