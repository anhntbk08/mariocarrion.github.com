<!doctype html><html lang=en-us><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Mario Carrion"><meta name=description content="ifacecodegen a tool generating middleware from interfaces."><meta property="og:title" content="Go Tool: ifacecodegen"><meta property="og:description" content="ifacecodegen a tool generating middleware from interfaces."><meta property="og:type" content="article"><meta property="og:url" content="https://www.mariocarrion.com/2019/07/17/golang-tools-ifacecodegen.html"><meta property="article:published_time" content="2019-07-17T00:00:00+00:00"><meta property="article:modified_time" content="2019-07-17T00:00:00+00:00"><title>Go Tool: ifacecodegen</title><link rel=canonical href=https://www.mariocarrion.com/2019/07/17/golang-tools-ifacecodegen.html><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel=stylesheet><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/favicon.png><link rel=alternate type=application/rss+xml title="RSS Feed" href=/index.xml><body><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/img/logo.png></a>
<a href=/><div class=name>Mario Carrion</div></a><nav><ul><li class=nav-about><a href=https://www.mariocarrion.com/about.html><span>About</span></a><li class=nav-archive><a href=https://www.mariocarrion.com/archive.html><span>All Posts</span></a><li class=nav-books><a href=https://www.mariocarrion.com/books.html><span>Books</span></a><li class=nav-resume><a href=https://docs.google.com/document/d/1i0W6qNfGMhTfwWTHBaaKzlN9HLGwbk3GLeh8VtVlhNM><span>Resume</span></a></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=/index.xml><img class=icon src=/img/rss.svg alt=rss></a>
<a href=//twitter.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//gitlab.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/gitlab.svg alt=gitlab></a>
<a href=//github.com/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//linkedin.com/in/MarioCarrion target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Go Tool: ifacecodegen</div><div class=initials><a href=https://www.mariocarrion.com></a></div></div><div class=meta><div class=date title="Wed Jul 17 2019 00:00:00 UTC">Jul 17, 2019</div></div></div><div class=markdown><p>Similar to <a href=/2019/06/24/golang-tools-counterfeiter.html><code>counterfeiter</code></a> we use another tool called <a href=https://github.com/fredipevcin/ifacecodegen><strong>ifacecodegen</strong></a> that allows us to automatically generate code from interface definitions using a Go template.<p><code>ifacecodegen</code> is used to generate code that satisfies an interface type and wraps the existing type implementing said interface, think of middleware code that will be used for logging purposes (using <a href=https://github.com/sirupsen/logrus>logurs</a>) or collecting metrics (using <a href=https://github.com/newrelic/go-agent/releases>NewRelic</a>).<p>For example, assuming you have code that follows the DDD paradigm (where there&rsquo;s a <em>Repository/Data Store</em> and some sort of <em>Service/Use Case</em>):<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#75715e>// User ...</span>
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>User</span> <span style=color:#66d9ef>struct</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#a6e22e>Role</span> <span style=color:#66d9ef>string</span>
<span style=color:#f8f8f2>}</span>

<span style=color:#75715e>// UserFinder finds an existing User from a remote data store.</span>
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserFinder</span> <span style=color:#66d9ef>interface</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#a6e22e>Find</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int64</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>(</span><span style=color:#a6e22e>User</span><span style=color:#f8f8f2>,</span> <span style=color:#66d9ef>error</span><span style=color:#f8f8f2>)</span>
<span style=color:#f8f8f2>}</span>

<span style=color:#75715e>// UserValidator determines if the requested user has specific roles.</span>
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserValidator</span> <span style=color:#66d9ef>struct</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>UserFinder</span>
<span style=color:#f8f8f2>}</span>

<span style=color:#75715e>// NewUserValidator ...</span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewUserValidator</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>f</span> <span style=color:#a6e22e>UserFinder</span><span style=color:#f8f8f2>)</span> <span style=color:#a6e22e>UserValidator</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>UserValidator</span><span style=color:#f8f8f2>{</span><span style=color:#a6e22e>f</span><span style=color:#f8f8f2>}</span>
<span style=color:#f8f8f2>}</span>

<span style=color:#75715e>// IsAdmin determines if the user with the specified id is an admin.</span>
<span style=color:#66d9ef>func</span> <span style=color:#f8f8f2>(</span><span style=color:#a6e22e>v</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>UserValidator</span><span style=color:#f8f8f2>)</span> <span style=color:#a6e22e>IsAdmin</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int64</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>(</span><span style=color:#66d9ef>bool</span><span style=color:#f8f8f2>,</span> <span style=color:#66d9ef>error</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#a6e22e>u</span><span style=color:#f8f8f2>,</span> <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>f</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Find</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>id</span><span style=color:#f8f8f2>)</span> <span style=color:#75715e>// XXX error validation omitted</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>u</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Role</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&quot;admin&quot;</span> <span style=color:#f8f8f2>{</span>
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f8f8f2>,</span> <span style=color:#66d9ef>nil</span>
	<span style=color:#f8f8f2>}</span>
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f8f8f2>,</span> <span style=color:#66d9ef>nil</span>
<span style=color:#f8f8f2>}</span>

<span style=color:#75715e>// IsGuest determines if the user with the specified id is a guest.</span>
<span style=color:#66d9ef>func</span> <span style=color:#f8f8f2>(</span><span style=color:#a6e22e>v</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>UserValidator</span><span style=color:#f8f8f2>)</span> <span style=color:#a6e22e>IsGuest</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int64</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>(</span><span style=color:#66d9ef>bool</span><span style=color:#f8f8f2>,</span> <span style=color:#66d9ef>error</span><span style=color:#f8f8f2>)</span> <span style=color:#f8f8f2>{</span>
	<span style=color:#a6e22e>u</span><span style=color:#f8f8f2>,</span> <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>f</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Find</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>id</span><span style=color:#f8f8f2>)</span> <span style=color:#75715e>// XXX error validation omitted</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>u</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Role</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&quot;guest&quot;</span> <span style=color:#f8f8f2>{</span>
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f8f8f2>,</span> <span style=color:#66d9ef>nil</span>
	<span style=color:#f8f8f2>}</span>
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f8f8f2>,</span> <span style=color:#66d9ef>nil</span>
<span style=color:#f8f8f2>}</span>
</code></pre></div><p>And you&rsquo;re planning to add logging support to determine how long each method takes when calling the remote data store method, you would need to do two things:<ol><li>Implement a template that does what your trying to achieve, and<li>Add a <a href=https://blog.golang.org/generate><code>generate</code></a> directive for generating that file.</ol><p>For the first thing, the template, the content of that one will look like:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>logger</span><span style=color:#f8f8f2>{{</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}}</span> <span style=color:#66d9ef>struct</span> <span style=color:#f8f8f2>{</span>
  <span style=color:#a6e22e>s</span> <span style=color:#f8f8f2>{{</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}}</span>
<span style=color:#f8f8f2>}</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewLogger</span><span style=color:#f8f8f2>{{</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}}(</span><span style=color:#a6e22e>s</span> <span style=color:#f8f8f2>{{</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}})</span> <span style=color:#f8f8f2>{{</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}}</span> <span style=color:#f8f8f2>{</span>
  <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>logger</span><span style=color:#f8f8f2>{{</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}}{</span>
    <span style=color:#a6e22e>s</span><span style=color:#f8f8f2>:</span> <span style=color:#a6e22e>s</span><span style=color:#f8f8f2>,</span>
  <span style=color:#f8f8f2>}</span>
<span style=color:#f8f8f2>}</span>

<span style=color:#f8f8f2>{{</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>ifaceRef</span> <span style=color:#f92672>:=</span> <span style=color:#f8f8f2>.</span> <span style=color:#f8f8f2>}}</span>
<span style=color:#f8f8f2>{{</span> <span style=color:#66d9ef>range</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Methods</span> <span style=color:#f8f8f2>}}</span>
  <span style=color:#66d9ef>func</span> <span style=color:#f8f8f2>(</span><span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>logger</span><span style=color:#f8f8f2>{{</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>ifaceRef</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}})</span> <span style=color:#f8f8f2>{{</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}}({{</span> <span style=color:#a6e22e>input_parameters</span> <span style=color:#f8f8f2>.</span> <span style=color:#f8f8f2>}})</span> <span style=color:#f8f8f2>{{</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>methodRef</span> <span style=color:#f92672>:=</span> <span style=color:#f8f8f2>.</span> <span style=color:#f8f8f2>}}{{</span> <span style=color:#a6e22e>output_parameters</span> <span style=color:#f8f8f2>.</span> <span style=color:#f8f8f2>}}</span> <span style=color:#f8f8f2>{</span>
    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Now</span><span style=color:#f8f8f2>()</span>
    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span><span style=color:#f8f8f2>()</span> <span style=color:#f8f8f2>{</span>
      <span style=color:#a6e22e>log</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Printf</span><span style=color:#f8f8f2>(</span><span style=color:#e6db74>&quot;%s took %s&quot;</span><span style=color:#f8f8f2>,</span> <span style=color:#e6db74>&quot;{{ .Name }}&quot;</span><span style=color:#f8f8f2>,</span> <span style=color:#a6e22e>time</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Since</span><span style=color:#f8f8f2>(</span><span style=color:#a6e22e>now</span><span style=color:#f8f8f2>))</span>
    <span style=color:#f8f8f2>}()</span>

    <span style=color:#f8f8f2>{{</span> <span style=color:#66d9ef>return</span> <span style=color:#f8f8f2>.</span> <span style=color:#f8f8f2>}}</span> <span style=color:#a6e22e>m</span><span style=color:#f8f8f2>.</span><span style=color:#a6e22e>s</span><span style=color:#f8f8f2>.{{</span> <span style=color:#f8f8f2>.</span><span style=color:#a6e22e>Name</span> <span style=color:#f8f8f2>}}({{</span> <span style=color:#a6e22e>input_calls</span> <span style=color:#f8f8f2>.</span> <span style=color:#f8f8f2>}})</span>
  <span style=color:#f8f8f2>}</span>
<span style=color:#f8f8f2>{{</span> <span style=color:#a6e22e>end</span> <span style=color:#f8f8f2>}}</span>
</code></pre></div><p>Last, Adding the following directive:<div class=highlight style=background:#272822><pre style=line-height:125%><code class=language-go data-lang=go><span></span><span style=color:#75715e>//go:generate ifacecodegen -source main.go -template logger.tmpl -destination logger.gen.go -package main</span>
</code></pre></div><p>With the generated code we should be able to still satisfy the contract defined by <code>UserFinder</code> and add logging support!<pre><code>$ ./ifacecodegen-example
2019/07/17 23:28:09 Find took 100.109011ms
2019/07/17 23:28:10 Find took 200.418756ms
</code></pre><p>Obviously this example is extremely simple but imagine the real human time you will save when you have hundreds of data store methods and you need to collect metrics for all them!<p>Feel free to browse the <a href=https://gitlab.com/MarioCarrion/blog-examples/tree/master/2019/07/17>complete program</a> and play with it!<p><code>ifacecodegen</code> is a simple yet powerful tool, highly recommended.<hr><p><img src=https://media.giphy.com/media/83QtfwKWdmSEo/giphy.gif alt="The more you know" title="The more you know"></p><br><p class=back-to-posts><a href=/archive.html>Back to posts</a></div><br><div class=disqus></div></div></div></section>